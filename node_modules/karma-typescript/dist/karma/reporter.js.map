{"version":3,"file":"reporter.js","sourceRoot":"","sources":["../../src/karma/reporter.ts"],"names":[],"mappings":"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","sourcesContent":["import * as istanbulCoverage from \"istanbul-lib-coverage\";\nimport * as istanbulReport from \"istanbul-lib-report\";\nimport * as istanbulSourceMaps from \"istanbul-lib-source-maps\";\nimport * as istanbulReports from \"istanbul-reports\";\n\nimport * as lodash from \"lodash\";\nimport * as path from \"path\";\n\nimport { Logger } from \"log4js\";\n\nimport { Threshold } from \"../istanbul/threshold\";\nimport { Configuration } from \"../shared/configuration\";\n\ntype BrowserCollection = {\n    forEach: any[]['forEach'];\n}\n\nconst reporterName = \"karma-typescript\";\n\nexport class Reporter {\n\n    public create: (baseReporterDecorator: any, logger: any) => void;\n\n    private log: Logger;\n    private coverageMap: WeakMap<any, any>;\n\n    constructor(config: Configuration, threshold: Threshold) {\n\n        // eslint-disable-next-line @typescript-eslint/no-this-alias\n        const that = this;\n\n        // tslint:disable-next-line:only-arrow-functions\n        this.create = function(baseReporterDecorator: any, logger: any) {\n\n            baseReporterDecorator(this);\n\n            that.log = logger.create(`reporter.${reporterName}`);\n\n            this.onRunStart = () => {\n                that.coverageMap = new WeakMap<any, any>();\n            };\n\n            this.onBrowserStart = () => { /**/ };\n            this.specFailure = () => { /**/ };\n\n            this.onBrowserComplete = (browser: any, result: any) => {\n                if (result && result.coverage) {\n                    that.coverageMap.set(browser, result.coverage);\n                }\n            };\n\n            this.onRunComplete = async (collection: BrowserCollection, results: any) => {\n                const browsers: any[] = [];\n                collection.forEach((browser) => browsers.push(browser));\n\n                const coverageChecks = browsers.map(async (browser) => {\n                    const coverage = that.coverageMap.get(browser);\n                    const coverageMap = istanbulCoverage.createCoverageMap();\n                    coverageMap.merge(coverage);\n\n                    const sourceMapStore = istanbulSourceMaps.createSourceMapStore();\n                    const remappedCoverageMap = await sourceMapStore.transformCoverage(coverageMap);\n\n                    Object.keys(config.reports).forEach((reportType: any) => {\n\n                        const reportConfig = config.reports[reportType] as any;\n                        const directory = that.getReportDestination(browser, reportConfig, reportType);\n\n                        if (directory) {\n                            that.log.debug(\"Writing coverage to %s\", directory);\n                        }\n\n                        const istanbulReportOptions = {\n                            coverageMap: remappedCoverageMap,\n                            dir: directory,\n                            sourceFinder: sourceMapStore.sourceFinder,\n                            watermarks: config.coverageOptions.watermarks\n                        };\n                        const context = istanbulReport.createContext(istanbulReportOptions);\n\n                        istanbulReports\n                            .create(reportType, { file: reportConfig ? reportConfig.filename : undefined })\n                            // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n                            // @ts-ignore\n                            .execute(context);\n\n                        });\n\n                    return results\n                        && config.hasCoverageThreshold\n                        && !threshold.check(browser, remappedCoverageMap);\n                });\n\n                const isCoverageCheckFailed = (await Promise.all(coverageChecks))\n                    .some(isCheckFailed => isCheckFailed);\n\n                if (isCoverageCheckFailed && config.karma.singleRun) {\n                    process.exit(1);\n                }\n            };\n        };\n\n        Object.assign(this.create, { $inject: [\"baseReporterDecorator\", \"logger\", \"config\"] });\n    }\n\n    private getReportDestination(browser: any, reportConfig: any, reportType: any) {\n\n        if (lodash.isPlainObject(reportConfig)) {\n            let subdirectory = reportConfig.subdirectory ?? browser.name;\n            if (typeof subdirectory === \"function\") {\n                subdirectory = subdirectory(browser);\n            }\n\n            return path.join(reportConfig.directory ?? \"coverage\", subdirectory);\n        }\n\n        if (lodash.isString(reportConfig) && reportConfig.length > 0) {\n            return path.join(reportConfig, browser.name, reportType);\n        }\n\n        return null;\n    }\n}\n"]}
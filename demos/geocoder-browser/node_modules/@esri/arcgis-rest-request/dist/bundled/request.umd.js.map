{"version":3,"file":"request.umd.js","sources":["../../src/utils/process-params.ts","../../src/utils/encode-query-string.ts","../../../arcgis-rest-form-data/browser-ponyfill.mjs","../../src/utils/encode-form-data.ts","../../src/utils/ArcGISRequestError.ts","../../src/utils/warn.ts","../../../arcgis-rest-fetch/browser-ponyfill.mjs","../../src/request.ts","../../src/utils/append-custom-params.ts","../../src/utils/ArcGISAccessDeniedError.ts","../../src/utils/clean-url.ts","../../src/utils/decode-query-string.ts","../../src/utils/ErrorTypes.ts","../../src/fetch-token.ts","../../src/ApplicationCredentialsManager.ts","../../src/ApiKeyManager.ts","../../src/generate-token.ts","../../src/federation-utils.ts","../../src/validate-app-access.ts","../../src/revoke-token.ts","../../src/utils/base-64-url.ts","../../src/utils/generate-code-challenge.ts","../../src/utils/generate-random-string.ts","../../src/ArcGISIdentityManager.ts","../../src/app-tokens.ts"],"sourcesContent":["/* Copyright (c) 2017 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\n/**\n * Checks parameters to see if we should use FormData to send the request\n * @param params The object whose keys will be encoded.\n * @return A boolean indicating if FormData will be required.\n */\nexport function requiresFormData(params: any) {\n  return Object.keys(params).some(key => {\n    let value = params[key];\n\n    if (!value) {\n      return false;\n    }\n\n    if (value && value.toParam) {\n      value = value.toParam();\n    }\n\n    const type = value.constructor.name;\n\n    switch (type) {\n      case \"Array\":\n        return false;\n      case \"Object\":\n        return false;\n      case \"Date\":\n        return false;\n      case \"Function\":\n        return false;\n      case \"Boolean\":\n        return false;\n      case \"String\":\n        return false;\n      case \"Number\":\n        return false;\n      default:\n        return true;\n    }\n  });\n}\n\n/**\n * Converts parameters to the proper representation to send to the ArcGIS REST API.\n * @param params The object whose keys will be encoded.\n * @return A new object with properly encoded values.\n */\nexport function processParams(params: any): any {\n  const newParams: any = {};\n\n  Object.keys(params).forEach(key => {\n    let param = params[key];\n\n    if (param && param.toParam) {\n      param = param.toParam();\n    }\n\n    if (\n      !param &&\n      param !== 0 &&\n      typeof param !== \"boolean\" &&\n      typeof param !== \"string\"\n    ) {\n      return;\n    }\n\n    const type = param.constructor.name;\n\n    let value: any;\n\n    // properly encodes objects, arrays and dates for arcgis.com and other services.\n    // ported from https://github.com/Esri/esri-leaflet/blob/master/src/Request.js#L22-L30\n    // also see https://github.com/Esri/arcgis-rest-js/issues/18:\n    // null, undefined, function are excluded. If you want to send an empty key you need to send an empty string \"\".\n    switch (type) {\n      case \"Array\":\n        // Based on the first element of the array, classify array as an array of arrays, an array of objects\n        // to be stringified, or an array of non-objects to be comma-separated\n        // eslint-disable-next-line no-case-declarations\n        const firstElementType = param[0]?.constructor?.name;\n        value =\n          firstElementType === \"Array\" ? param : // pass thru array of arrays\n          firstElementType === \"Object\" ? JSON.stringify(param) : // stringify array of objects\n          param.join(\",\"); // join other types of array elements\n        break;\n      case \"Object\":\n        value = JSON.stringify(param);\n        break;\n      case \"Date\":\n        value = param.valueOf();\n        break;\n      case \"Function\":\n        value = null;\n        break;\n      case \"Boolean\":\n        value = param + \"\";\n        break;\n      default:\n        value = param;\n        break;\n    }\n    if (value || value === 0 || typeof value === \"string\" || Array.isArray(value)) {\n      newParams[key] = value;\n    }\n  });\n\n  return newParams;\n}\n","/* Copyright (c) 2017 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport { processParams } from \"./process-params.js\";\n\n/**\n * Encodes keys and parameters for use in a URL's query string.\n *\n * @param key Parameter's key\n * @param value Parameter's value\n * @returns Query string with key and value pairs separated by \"&\"\n */\nexport function encodeParam(key: string, value: any): string {\n  // For array of arrays, repeat key=value for each element of containing array\n  if (Array.isArray(value) && value[0] && Array.isArray(value[0])) {\n    return value\n      .map((arrayElem: string) => encodeParam(key, arrayElem))\n      .join(\"&\");\n  }\n\n  return encodeURIComponent(key) + \"=\" + encodeURIComponent(value);\n}\n\n/**\n * Encodes the passed object as a query string.\n *\n * @param params An object to be encoded.\n * @returns An encoded query string.\n */\nexport function encodeQueryString(params: any): string {\n  const newParams = processParams(params);\n  return Object.keys(newParams)\n    .map((key: any) => {\n      return encodeParam(key, newParams[key]);\n    })\n    .join(\"&\");\n}\n","export const FormData = globalThis.FormData;\nexport const File = globalThis.File;\nexport const Blob = globalThis.Blob;\n","/* Copyright (c) 2017 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport { processParams, requiresFormData } from \"./process-params.js\";\nimport { encodeQueryString } from \"./encode-query-string.js\";\nimport { FormData } from \"@esri/arcgis-rest-form-data\";\n\n/**\n * Encodes parameters in a [FormData](https://developer.mozilla.org/en-US/docs/Web/API/FormData) object in browsers or in a [FormData](https://github.com/form-data/form-data) in Node.js\n *\n * @param params An object to be encoded.\n * @returns The complete [FormData](https://developer.mozilla.org/en-US/docs/Web/API/FormData) object.\n */\nexport function encodeFormData(\n  params: any,\n  forceFormData?: boolean\n): FormData | string {\n  // see https://github.com/Esri/arcgis-rest-js/issues/499 for more info.\n  const useFormData = requiresFormData(params) || forceFormData;\n  const newParams = processParams(params);\n  if (useFormData) {\n    const formData = new FormData();\n\n    Object.keys(newParams).forEach((key: any) => {\n      if (typeof Blob !== \"undefined\" && newParams[key] instanceof Blob) {\n        /* To name the Blob:\n         1. look to an alternate request parameter called 'fileName'\n         2. see if 'name' has been tacked onto the Blob manually\n         3. if all else fails, use the request parameter\n        */\n        const filename = newParams[\"fileName\"] || newParams[key].name || key;\n        formData.append(key, newParams[key], filename);\n      } else {\n        formData.append(key, newParams[key]);\n      }\n    });\n    return formData;\n  } else {\n    return encodeQueryString(params);\n  }\n}\n","/* Copyright (c) 2017 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport { IRequestOptions } from \"./IRequestOptions.js\";\n\n// TypeScript 2.1 no longer allows you to extend built in types. See https://github.com/Microsoft/TypeScript/issues/12790#issuecomment-265981442\n// and https://github.com/Microsoft/TypeScript-wiki/blob/master/Breaking-Changes.md#extending-built-ins-like-error-array-and-map-may-no-longer-work\n//\n// This code is from MDN https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error#Custom_Error_Types.\nexport class ArcGISRequestError extends Error {\n  /**\n   * The name of this error. Will always be `\"ArcGISRequestError\"` to conform with the [`Error`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error) class.\n   */\n  public name: string;\n\n  /**\n   * Formatted error message. See the [`Error`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error) class for more details.\n   */\n  public message: string;\n\n  /**\n   * The errror message return from the request.\n   */\n  public originalMessage: string;\n\n  /**\n   * The error code returned from the request.\n   */\n  public code: string | number;\n\n  /**\n   * The original JSON response the caused the error.\n   */\n  public response: any;\n\n  /**\n   * The URL of the original request that caused the error\n   */\n  public url: string;\n\n  /**\n   * The options of the original request that caused the error\n   */\n  public options: IRequestOptions;\n\n  /**\n   * Create a new `ArcGISRequestError`  object.\n   *\n   * @param message - The error message from the API\n   * @param code - The error code from the API\n   * @param response - The original response from the API that caused the error\n   * @param url - The original url of the request\n   * @param options - The original options and parameters of the request\n   */\n  constructor(\n    message?: string,\n    code?: string | number,\n    response?: any,\n    url?: string,\n    options?: IRequestOptions\n  ) {\n    // 'Error' breaks prototype chain here\n    super(message);\n\n    // restore prototype chain, see https://stackoverflow.com/questions/41102060/typescript-extending-error-class\n    // we don't need to check for Object.setPrototypeOf as in the answers becasue we are ES2017 now\n    const actualProto = new.target.prototype;\n    Object.setPrototypeOf(this, actualProto);\n\n    message = message || \"UNKNOWN_ERROR\";\n    code = code || \"UNKNOWN_ERROR_CODE\";\n\n    this.name = \"ArcGISRequestError\";\n    this.message =\n      code === \"UNKNOWN_ERROR_CODE\" ? message : `${code}: ${message}`;\n    this.originalMessage = message;\n    this.code = code;\n    this.response = response;\n    this.url = url;\n    this.options = options;\n  }\n}\n","/* Copyright (c) 2017-2018 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\n/**\n * Method used internally to surface messages to developers.\n */\nexport function warn(message: string) {\n  if (console && console.warn) {\n    console.warn.apply(console, [message]);\n  }\n}\n","export function getFetch() {\n  return Promise.resolve({\n    fetch: globalThis.fetch,\n    Headers: globalThis.Headers,\n    Response: globalThis.Response,\n    Request: globalThis.Request\n  });\n}\n","/* Copyright (c) 2017-2018 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport { encodeFormData } from \"./utils/encode-form-data.js\";\nimport { encodeQueryString } from \"./utils/encode-query-string.js\";\nimport { requiresFormData } from \"./utils/process-params.js\";\nimport { ArcGISRequestError } from \"./utils/ArcGISRequestError.js\";\nimport { IRequestOptions } from \"./utils/IRequestOptions.js\";\nimport { IParams } from \"./utils/IParams.js\";\nimport { warn } from \"./utils/warn.js\";\nimport { IRetryAuthError } from \"./utils/retryAuthError.js\";\nimport { getFetch } from \"@esri/arcgis-rest-fetch\";\nimport { IAuthenticationManager } from \"./index.js\";\n\nexport const NODEJS_DEFAULT_REFERER_HEADER = `@esri/arcgis-rest-js`;\n\n/**\n * Sets the default options that will be passed in **all requests across all `@esri/arcgis-rest-js` modules**.\n *\n *\n * ```js\n * import { setDefaultRequestOptions } from \"@esri/arcgis-rest-request\";\n * setDefaultRequestOptions({\n *   authentication: ArcGISIdentityManager // all requests will use this session by default\n * })\n * ```\n * You should **never** set a default `authentication` when you are in a server side environment where you may be handling requests for many different authenticated users.\n *\n * @param options The default options to pass with every request. Existing default will be overwritten.\n * @param hideWarnings Silence warnings about setting default `authentication` in shared environments.\n */\nexport function setDefaultRequestOptions(\n  options: IRequestOptions,\n  hideWarnings?: boolean\n) {\n  if (options.authentication && !hideWarnings) {\n    warn(\n      \"You should not set `authentication` as a default in a shared environment such as a web server which will process multiple users requests. You can call `setDefaultRequestOptions` with `true` as a second argument to disable this warning.\"\n    );\n  }\n  (globalThis as any).DEFAULT_ARCGIS_REQUEST_OPTIONS = options;\n}\n\nexport function getDefaultRequestOptions() {\n  return (\n    (globalThis as any).DEFAULT_ARCGIS_REQUEST_OPTIONS || {\n      httpMethod: \"POST\",\n      params: {\n        f: \"json\"\n      }\n    }\n  );\n}\n\nexport class ArcGISAuthError extends ArcGISRequestError {\n  /**\n   * Create a new `ArcGISAuthError`  object.\n   *\n   * @param message - The error message from the API\n   * @param code - The error code from the API\n   * @param response - The original response from the API that caused the error\n   * @param url - The original url of the request\n   * @param options - The original options of the request\n   */\n  constructor(\n    message = \"AUTHENTICATION_ERROR\",\n    code: string | number = \"AUTHENTICATION_ERROR_CODE\",\n    response?: any,\n    url?: string,\n    options?: IRequestOptions\n  ) {\n    super(message, code, response, url, options);\n    this.name = \"ArcGISAuthError\";\n    this.message =\n      code === \"AUTHENTICATION_ERROR_CODE\" ? message : `${code}: ${message}`;\n  }\n\n  public retry(getSession: IRetryAuthError, retryLimit = 1) {\n    let tries = 0;\n\n    const retryRequest = (resolve: any, reject: any) => {\n      tries = tries + 1;\n\n      getSession(this.url, this.options)\n        .then((session) => {\n          const newOptions = {\n            ...this.options,\n            ...{ authentication: session }\n          };\n\n          return internalRequest(this.url, newOptions);\n        })\n        .then((response) => {\n          resolve(response);\n        })\n        .catch((e) => {\n          if (e.name === \"ArcGISAuthError\" && tries < retryLimit) {\n            retryRequest(resolve, reject);\n          } else if (\n            e.name === this.name &&\n            e.message === this.message &&\n            tries >= retryLimit\n          ) {\n            reject(this);\n          } else {\n            reject(e);\n          }\n        });\n    };\n\n    return new Promise((resolve, reject) => {\n      retryRequest(resolve, reject);\n    });\n  }\n}\n\n/**\n * Checks for errors in a JSON response from the ArcGIS REST API. If there are no errors, it will return the `data` passed in. If there is an error, it will throw an `ArcGISRequestError` or `ArcGISAuthError`.\n *\n * @param data The response JSON to check for errors.\n * @param url The url of the original request\n * @param params The parameters of the original request\n * @param options The options of the original request\n * @returns The data that was passed in the `data` parameter\n */\nexport function checkForErrors(\n  response: any,\n  url?: string,\n  params?: IParams,\n  options?: IRequestOptions,\n  originalAuthError?: ArcGISAuthError\n): any {\n  // this is an error message from billing.arcgis.com backend\n  if (response.code >= 400) {\n    const { message, code } = response;\n    throw new ArcGISRequestError(message, code, response, url, options);\n  }\n\n  // error from ArcGIS Online or an ArcGIS Portal or server instance.\n  if (response.error) {\n    const { message, code, messageCode } = response.error;\n    const errorCode = messageCode || code || \"UNKNOWN_ERROR_CODE\";\n\n    if (\n      code === 498 ||\n      code === 499 ||\n      messageCode === \"GWM_0003\" ||\n      (code === 400 && message === \"Unable to generate token.\")\n    ) {\n      if (originalAuthError) {\n        throw originalAuthError;\n      } else {\n        throw new ArcGISAuthError(message, errorCode, response, url, options);\n      }\n    }\n\n    throw new ArcGISRequestError(message, errorCode, response, url, options);\n  }\n\n  // error from a status check\n  if (response.status === \"failed\" || response.status === \"failure\") {\n    let message: string;\n    let code = \"UNKNOWN_ERROR_CODE\";\n\n    try {\n      message = JSON.parse(response.statusMessage).message;\n      code = JSON.parse(response.statusMessage).code;\n    } catch (e) {\n      message = response.statusMessage || response.message;\n    }\n\n    throw new ArcGISRequestError(message, code, response, url, options);\n  }\n\n  return response;\n}\n\n/**\n * This is the internal implementation of `request` without the automatic retry behavior to prevent\n * infinite loops when a server continues to return invalid token errors.\n *\n * @param url - The URL of the ArcGIS REST API endpoint.\n * @param requestOptions - Options for the request, including parameters relevant to the endpoint.\n * @returns A Promise that will resolve with the data from the response.\n * @internal\n */\nexport function internalRequest(\n  url: string,\n  requestOptions: IRequestOptions\n): Promise<any> {\n  const defaults = getDefaultRequestOptions();\n  const options: IRequestOptions = {\n    ...{ httpMethod: \"POST\" },\n    ...defaults,\n    ...requestOptions,\n    ...{\n      params: {\n        ...defaults.params,\n        ...requestOptions.params\n      },\n      headers: {\n        ...defaults.headers,\n        ...requestOptions.headers\n      }\n    }\n  };\n\n  const { httpMethod, rawResponse } = options;\n\n  const params: IParams = {\n    ...{ f: \"json\" },\n    ...options.params\n  };\n\n  let originalAuthError: ArcGISAuthError = null;\n\n  const fetchOptions: RequestInit = {\n    method: httpMethod,\n    /* ensures behavior mimics XMLHttpRequest.\n    needed to support sending IWA cookies */\n    credentials: options.credentials || \"same-origin\"\n  };\n\n  // the /oauth2/platformSelf route will add X-Esri-Auth-Client-Id header\n  // and that request needs to send cookies cross domain\n  // so we need to set the credentials to \"include\"\n  if (\n    options.headers &&\n    options.headers[\"X-Esri-Auth-Client-Id\"] &&\n    url.indexOf(\"/oauth2/platformSelf\") > -1\n  ) {\n    fetchOptions.credentials = \"include\";\n  }\n\n  let authentication: IAuthenticationManager;\n\n  // Check to see if this is a raw token as a string and create a IAuthenticationManager like object for it.\n  // Otherwise this just assumes that options.authentication is an IAuthenticationManager.\n  if (typeof options.authentication === \"string\") {\n    const rawToken = options.authentication;\n\n    authentication = {\n      portal: \"https://www.arcgis.com/sharing/rest\",\n      getToken: () => {\n        return Promise.resolve(rawToken);\n      }\n    };\n\n    /* istanbul ignore else - we don't need to test NOT warning people */\n    if (\n      !options.authentication.startsWith(\"AAPK\") && // doesn't look like an API Key\n      !options.suppressWarnings && // user doesn't want to suppress warnings for this request\n      !(globalThis as any).ARCGIS_REST_JS_SUPPRESS_TOKEN_WARNING // we havn't shown the user this warning yet\n    ) {\n      warn(\n        `Using an oAuth 2.0 access token directly in the token option is discouraged. Consider using ArcGISIdentityManager or Application session. See https://esriurl.com/arcgis-rest-js-direct-token-warning for more information.`\n      );\n\n      (globalThis as any).ARCGIS_REST_JS_SUPPRESS_TOKEN_WARNING = true;\n    }\n  } else {\n    authentication = options.authentication;\n  }\n\n  // for errors in GET requests we want the URL passed to the error to be the URL before\n  // query params are applied.\n  const originalUrl = url;\n\n  return (\n    authentication\n      ? authentication.getToken(url).catch((err) => {\n          /**\n           * append original request url and requestOptions\n           * to the error thrown by getToken()\n           * to assist with retrying\n           */\n          err.url = url;\n          err.options = options;\n          /**\n           * if an attempt is made to talk to an unfederated server\n           * first try the request anonymously. if a 'token required'\n           * error is thrown, throw the UNFEDERATED error then.\n           */\n          originalAuthError = err;\n          return Promise.resolve(\"\");\n        })\n      : Promise.resolve(\"\")\n  )\n    .then((token) => {\n      if (token.length) {\n        params.token = token;\n      }\n\n      if (authentication && authentication.getDomainCredentials) {\n        fetchOptions.credentials = authentication.getDomainCredentials(url);\n      }\n\n      // Custom headers to add to request. IRequestOptions.headers with merge over requestHeaders.\n      const requestHeaders: {\n        [key: string]: any;\n      } = {};\n\n      if (fetchOptions.method === \"GET\") {\n        // Prevents token from being passed in query params when hideToken option is used.\n        /* istanbul ignore if - window is always defined in a browser. Test case is covered by Jasmine in node test */\n        if (\n          params.token &&\n          options.hideToken &&\n          // Sharing API does not support preflight check required by modern browsers https://developer.mozilla.org/en-US/docs/Glossary/Preflight_request\n          typeof window === \"undefined\"\n        ) {\n          requestHeaders[\"X-Esri-Authorization\"] = `Bearer ${params.token}`;\n          delete params.token;\n        }\n        // encode the parameters into the query string\n        const queryParams = encodeQueryString(params);\n        // dont append a '?' unless parameters are actually present\n        const urlWithQueryString =\n          queryParams === \"\" ? url : url + \"?\" + encodeQueryString(params);\n\n        if (\n          // This would exceed the maximum length for URLs specified by the consumer and requires POST\n          (options.maxUrlLength &&\n            urlWithQueryString.length > options.maxUrlLength) ||\n          // Or if the customer requires the token to be hidden and it has not already been hidden in the header (for browsers)\n          (params.token && options.hideToken)\n        ) {\n          // the consumer specified a maximum length for URLs\n          // and this would exceed it, so use post instead\n          fetchOptions.method = \"POST\";\n\n          // If the token was already added as a Auth header, add the token back to body with other params instead of header\n          if (token.length && options.hideToken) {\n            params.token = token;\n            // Remove existing header that was added before url query length was checked\n            delete requestHeaders[\"X-Esri-Authorization\"];\n          }\n        } else {\n          // just use GET\n          url = urlWithQueryString;\n        }\n      }\n\n      /* updateResources currently requires FormData even when the input parameters dont warrant it.\n  https://developers.arcgis.com/rest/users-groups-and-items/update-resources.htm\n      see https://github.com/Esri/arcgis-rest-js/pull/500 for more info. */\n      const forceFormData = new RegExp(\"/items/.+/updateResources\").test(url);\n\n      if (fetchOptions.method === \"POST\") {\n        fetchOptions.body = encodeFormData(params, forceFormData) as any;\n      }\n\n      // Mixin headers from request options\n      fetchOptions.headers = {\n        ...requestHeaders,\n        ...options.headers\n      };\n\n      /* istanbul ignore next - karma reports coverage on browser tests only */\n      if (typeof window === \"undefined\" && !fetchOptions.headers.referer) {\n        fetchOptions.headers.referer = NODEJS_DEFAULT_REFERER_HEADER;\n      }\n\n      /* istanbul ignore else blob responses are difficult to make cross platform we will just have to trust the isomorphic fetch will do its job */\n      if (!requiresFormData(params) && !forceFormData) {\n        fetchOptions.headers[\"Content-Type\"] =\n          \"application/x-www-form-urlencoded\";\n      }\n\n      /**\n       * Check for a global fetch first and use it if available. This allows us to use the default\n       * configuration of fetch-mock in tests.\n       */\n\n      /* istanbul ignore next coverage is based on browser code and we don't test for the absence of global fetch so we can skip the else here. */\n      return globalThis.fetch\n        ? globalThis.fetch(url, fetchOptions)\n        : getFetch().then(({ fetch }) => {\n            return fetch(url, fetchOptions);\n          });\n    })\n    .then((response: any) => {\n      if (!response.ok) {\n        // server responded w/ an actual error (404, 500, etc)\n        const { status, statusText } = response;\n        throw new ArcGISRequestError(\n          statusText,\n          `HTTP ${status}`,\n          response,\n          url,\n          options\n        );\n      }\n      if (rawResponse) {\n        return response;\n      }\n      switch (params.f) {\n        case \"json\":\n          return response.json();\n        case \"geojson\":\n          return response.json();\n        case \"html\":\n          return response.text();\n        case \"text\":\n          return response.text();\n        /* istanbul ignore next blob responses are difficult to make cross platform we will just have to trust that isomorphic fetch will do its job */\n        default:\n          return response.blob();\n      }\n    })\n    .then((data) => {\n      if ((params.f === \"json\" || params.f === \"geojson\") && !rawResponse) {\n        const response = checkForErrors(\n          data,\n          originalUrl,\n          params,\n          options,\n          originalAuthError\n        );\n\n        if (originalAuthError) {\n          /* If the request was made to an unfederated service that\n          didn't require authentication, add the base url and a dummy token\n          to the list of trusted servers to avoid another federation check\n          in the event of a repeat request */\n          const truncatedUrl: string = url\n            .toLowerCase()\n            .split(/\\/rest(\\/admin)?\\/services\\//)[0];\n\n          (options.authentication as any).federatedServers[truncatedUrl] = {\n            token: [],\n            // default to 24 hours\n            expires: new Date(Date.now() + 86400 * 1000)\n          };\n          originalAuthError = null;\n        }\n        return response;\n      } else {\n        return data;\n      }\n    });\n}\n\n/**\n * ```js\n * import { request } from '@esri/arcgis-rest-request';\n * //\n * request('https://www.arcgis.com/sharing/rest')\n *   .then(response) // response.currentVersion === 5.2\n * //\n * request('https://www.arcgis.com/sharing/rest', {\n *   httpMethod: \"GET\"\n * })\n * //\n * request('https://www.arcgis.com/sharing/rest/search', {\n *   params: { q: 'parks' }\n * })\n *   .then(response) // response.total => 78379\n * ```\n * Generic method for making HTTP requests to ArcGIS REST API endpoints.\n *\n * @param url - The URL of the ArcGIS REST API endpoint.\n * @param requestOptions - Options for the request, including parameters relevant to the endpoint.\n * @returns A Promise that will resolve with the data from the response.\n */\nexport function request(\n  url: string,\n  requestOptions: IRequestOptions = { params: { f: \"json\" } }\n): Promise<any> {\n  return internalRequest(url, requestOptions).catch((e) => {\n    if (\n      e instanceof ArcGISAuthError &&\n      e.code === 498 &&\n      e.message === \"498: Invalid token.\" &&\n      requestOptions.authentication &&\n      typeof requestOptions.authentication !== \"string\" &&\n      requestOptions.authentication.canRefresh &&\n      requestOptions.authentication.refreshCredentials\n    ) {\n      return e.retry(() => {\n        return (requestOptions.authentication as any).refreshCredentials();\n      }, 1);\n    } else {\n      return Promise.reject(e);\n    }\n  });\n}\n","/* Copyright (c) 2017-2018 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport { IRequestOptions } from \"./IRequestOptions.js\";\n\n/**\n * Helper for methods with lots of first order request options to pass through as request parameters.\n */\nexport function appendCustomParams<T extends IRequestOptions>(\n  customOptions: T,\n  keys: Array<keyof T>,\n  baseOptions?: Partial<T>\n): IRequestOptions {\n  const requestOptionsKeys = [\n    \"params\",\n    \"httpMethod\",\n    \"rawResponse\",\n    \"authentication\",\n    \"portal\",\n    \"fetch\",\n    \"maxUrlLength\",\n    \"headers\",\n  ];\n\n  const options: T = {\n    ...{ params: {} },\n    ...baseOptions,\n    ...customOptions,\n  };\n\n  // merge all keys in customOptions into options.params\n  options.params = keys.reduce((value, key) => {\n    if (customOptions[key] || typeof customOptions[key] === \"boolean\") {\n      value[key as any] = customOptions[key];\n    }\n    return value;\n  }, options.params);\n\n  // now remove all properties in options that don't exist in IRequestOptions\n  return requestOptionsKeys.reduce((value, key) => {\n    if ((options as any)[key]) {\n      (value as any)[key] = (options as any)[key];\n    }\n    return value;\n  }, {} as IRequestOptions);\n}\n","/* Copyright (c) 2022 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\n// TypeScript 2.1 no longer allows you to extend built in types. See https://github.com/Microsoft/TypeScript/issues/12790#issuecomment-265981442\n// and https://github.com/Microsoft/TypeScript-wiki/blob/master/Breaking-Changes.md#extending-built-ins-like-error-array-and-map-may-no-longer-work\n//\n// This code is from MDN https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error#Custom_Error_Types.\nexport class ArcGISAccessDeniedError extends Error {\n  /**\n   * The name of this error. Will always be `\"ArcGISAccessDeniedError\"` to conform with the [`Error`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error) class.\n   */\n  public name: string;\n\n  /**\n   * Formatted error message. See the [`Error`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Error) class for more details.\n   */\n  public message: string;\n\n  /**\n   * Create a new `ArcGISAccessDeniedError`  object.\n   */\n  constructor() {\n    const message = \"The user has denied your authorization request.\";\n\n    super(message);\n\n    // restore prototype chain, see https://stackoverflow.com/questions/41102060/typescript-extending-error-class\n    // we don't need to check for Object.setPrototypeOf as in the answers becasue we are ES2017 now\n    const actualProto = new.target.prototype;\n    Object.setPrototypeOf(this, actualProto);\n\n    this.name = \"ArcGISAccessDeniedError\";\n  }\n}\n","/* Copyright (c) 2018 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\n/**\n * Helper method to ensure that user supplied urls don't include whitespace or a trailing slash.\n */\nexport function cleanUrl(url: string) {\n  // Guard so we don't try to trim something that's not a string\n  if (typeof url !== \"string\") {\n    return url;\n  }\n  // trim leading and trailing spaces, but not spaces inside the url\n  url = url.trim();\n\n  // remove the trailing slash to the url if one was included\n  if (url[url.length - 1] === \"/\") {\n    url = url.slice(0, -1);\n  }\n  return url;\n}\n","/* Copyright (c) 2017-2020 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nexport function decodeParam(param: string): { key: string; value: string } {\n  const [key, value] = param.split(\"=\");\n  return { key: decodeURIComponent(key), value: decodeURIComponent(value) };\n}\n\n/**\n * Decodes the passed query string as an object.\n *\n * @param query A string to be decoded.\n * @returns A decoded query param object.\n */\nexport function decodeQueryString(query?: string): { [key: string]: string } {\n  if (!query || query.length <= 0) {\n    return {};\n  }\n\n  return query\n    .replace(/^#/, \"\")\n    .replace(/^\\?/, \"\")\n    .split(\"&\")\n    .reduce((acc, entry) => {\n      const { key, value } = decodeParam(entry);\n      acc[key] = value;\n      return acc;\n    }, {} as any);\n}\n","/* Copyright (c) 2017 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\n/**\n * Enum describing the different errors that might be thrown by a request.\n *\n * ```ts\n * import { request, ErrorTypes } from '@esri/arcgis-rest-request';\n *\n * request(\"...\").catch((e) => {\n *   switch(e.name) {\n *     case ErrorType.ArcGISRequestError:\n *     // handle a general error from the API\n *     break;\n *\n *     case ErrorType.ArcGISAuthError:\n *     // handle an authentication error\n *     break;\n *\n *     case ErrorType.ArcGISAccessDeniedError:\n *     // handle a user denying an authorization request in an oAuth workflow\n *     break;\n *\n *     default:\n *     // handle some other error (usually a network error)\n *   }\n * });\n * ```\n */\nexport enum ErrorTypes {\n  ArcGISRequestError = \"ArcGISRequestError\",\n  ArcGISAuthError = \"ArcGISAuthError\",\n  ArcGISAccessDeniedError = \"ArcGISAccessDeniedError\"\n}\n","/* Copyright (c) 2017 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport { request } from \"./request.js\";\nimport { IRequestOptions } from \"./utils/IRequestOptions.js\";\nimport { ITokenRequestOptions } from \"./utils/ITokenRequestOptions.js\";\n\nconst FIVE_MINUTES_IN_MILLISECONDS = 5 * 60 * 1000;\n\ninterface IFetchTokenRawResponse {\n  access_token: string;\n  expires_in: number;\n  username: string;\n  ssl?: boolean;\n  refresh_token?: string;\n  refresh_token_expires_in?: number;\n}\n\nexport interface IFetchTokenResponse {\n  token: string;\n  expires: Date;\n  username: string;\n  ssl: boolean;\n  refreshToken?: string;\n  refreshTokenExpires?: Date;\n}\n\nexport function fetchToken(\n  url: string,\n  requestOptions: ITokenRequestOptions\n): Promise<IFetchTokenResponse> {\n  const options: IRequestOptions = requestOptions;\n\n  // we generate a response, so we can't return the raw response\n  options.rawResponse = false;\n\n  return request(url, options).then((response: IFetchTokenRawResponse) => {\n    const r: IFetchTokenResponse = {\n      token: response.access_token,\n      username: response.username,\n      expires: new Date(\n        // convert seconds in response to milliseconds and add the value to the current time to calculate a static expiration timestamp\n        // we subtract 5 minutes here to make sure that we refresh the token early if the user makes requests\n        Date.now() + response.expires_in * 1000 - FIVE_MINUTES_IN_MILLISECONDS\n      ),\n      ssl: response.ssl === true\n    };\n\n    if (response.refresh_token) {\n      r.refreshToken = response.refresh_token;\n    }\n\n    if (response.refresh_token_expires_in) {\n      r.refreshTokenExpires = new Date(\n        // convert seconds in response to milliseconds and add the value to the current time to calculate a static expiration timestamp\n        // we subtract 5 minutes here to make sure that we refresh the token early if the user makes requests\n        Date.now() +\n          response.refresh_token_expires_in * 1000 -\n          FIVE_MINUTES_IN_MILLISECONDS\n      );\n    }\n\n    return r;\n  });\n}\n","/* Copyright (c) 2017-2018 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport { IAuthenticationManager } from \"./utils/IAuthenticationManager.js\";\nimport { ITokenRequestOptions } from \"./utils/ITokenRequestOptions.js\";\nimport { fetchToken } from \"./fetch-token.js\";\n\nexport interface IApplicationCredentialsManagerOptions {\n  /**\n   * Client ID of your application. Can be obtained by registering an application\n   * on [ArcGIS for Developers](https://developers.arcgis.com/documentation/core-concepts/security-and-authentication/signing-in-arcgis-online-users/#registering-your-application),\n   * [ArcGIS Online](http://doc.arcgis.com/en/arcgis-online/share-maps/add-items.htm#ESRI_SECTION1_0D1B620254F745AE84F394289F8AF44B) or on your instance of ArcGIS Enterprise.\n   */\n  clientId: string;\n\n  /**\n   * A Client Secret is also obtained by registering an application\n   * on [ArcGIS for Developers](https://developers.arcgis.com/documentation/core-concepts/security-and-authentication/signing-in-arcgis-online-users/#registering-your-application),\n   * [ArcGIS Online](http://doc.arcgis.com/en/arcgis-online/share-maps/add-items.htm#ESRI_SECTION1_0D1B620254F745AE84F394289F8AF44B) or on your instance of ArcGIS Enterprise. Treat it like a password.\n   */\n  clientSecret: string;\n\n  /**\n   * OAuth 2.0 access token from a previous application session.\n   */\n  token?: string;\n\n  /**\n   * Expiration date for the `token`\n   */\n  expires?: Date;\n\n  /**\n   * URL of ArcGIS REST base, defaults to \"https://www.arcgis.com/sharing/rest\"\n   */\n  portal?: string;\n\n  /**\n   * Duration of requested tokens in minutes. defaults to 7200 (5 days).\n   */\n  duration?: number;\n}\n\n/**\n * Used to authenticate methods in ArcGIS REST JS with oAuth 2.0 application credentials. The instance of `ApplicationCredentialsManager` can be passed to  {@linkcode IRequestOptions.authentication} to authenticate requests.\n * ```js\n * import { ApplicationSession } from '@esri/arcgis-rest-auth';\n *\n * const session = ApplicationCredentialsManager.fromCredentials({\n *   clientId: \"abc123\",\n *   clientSecret: \"••••••\"\n * })\n * ```\n */\nexport class ApplicationCredentialsManager implements IAuthenticationManager {\n  public portal: string;\n  private clientId: string;\n  private clientSecret: string;\n  private token: string;\n  private expires: Date;\n  private duration: number;\n\n  /**\n   * Preferred method for creating an `ApplicationCredentialsManager`\n   */\n  public static fromCredentials(\n    options: IApplicationCredentialsManagerOptions\n  ) {\n    return new ApplicationCredentialsManager(options);\n  }\n\n  /**\n   * Internal object to keep track of pending token requests. Used to prevent\n   *  duplicate token requests.\n   */\n  private _pendingTokenRequest: Promise<string>;\n\n  constructor(options: IApplicationCredentialsManagerOptions) {\n    this.clientId = options.clientId;\n    this.clientSecret = options.clientSecret;\n    this.token = options.token;\n    this.expires = options.expires;\n    this.portal = options.portal || \"https://www.arcgis.com/sharing/rest\";\n    this.duration = options.duration || 7200;\n  }\n\n  // URL is not actually read or passed through.\n  public getToken(\n    url: string,\n    requestOptions?: ITokenRequestOptions\n  ): Promise<string> {\n    if (this.token && this.expires && this.expires.getTime() > Date.now()) {\n      return Promise.resolve(this.token);\n    }\n\n    if (this._pendingTokenRequest) {\n      return this._pendingTokenRequest;\n    }\n\n    this._pendingTokenRequest = this.refreshToken(requestOptions);\n\n    return this._pendingTokenRequest;\n  }\n\n  public refreshToken(requestOptions?: ITokenRequestOptions): Promise<string> {\n    const options = {\n      params: {\n        client_id: this.clientId,\n        client_secret: this.clientSecret,\n        grant_type: \"client_credentials\",\n        expiration: this.duration\n      },\n      ...requestOptions\n    };\n    return fetchToken(`${this.portal}/oauth2/token/`, options).then(\n      (response) => {\n        this._pendingTokenRequest = null;\n        this.token = response.token;\n        this.expires = response.expires;\n        return response.token;\n      }\n    );\n  }\n\n  public refreshCredentials() {\n    return this.refreshToken().then(() => this);\n  }\n}\n\n/**\n * @deprecated - Use {@linkcode ApplicationCredentialsManager}.\n */ /* istanbul ignore next */\nexport function ApplicationSession(\n  options: IApplicationCredentialsManagerOptions\n) {\n  console.log(\n    \"DEPRECATED:, 'ApplicationSession' is deprecated. Use 'ApplicationCredentialsManager' instead.\"\n  );\n\n  return new ApplicationCredentialsManager(options);\n}\n","/* Copyright (c) 2017-2019 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport { IAuthenticationManager } from \"./utils/IAuthenticationManager.js\";\n\n/**\n * Options for the `ApiKey` constructor.\n */\nexport interface IApiKeyOptions {\n  key: string;\n}\n\n/**\n * Used to authenticate methods in ArcGIS REST JS with an API keys. The instance of `ApiKeyManager` can be passed to  {@linkcode IRequestOptions.authentication} to authenticate requests.\n * \n * ```js\n * import { ApiKeyManager } from '@esri/arcgis-rest-auth';\n \n * const apiKey = new ApiKeyManager.fromKey(\"...\");\n * ```\n * \n * In most cases however the API key can be passed directly to the {@linkcode IRequestOptions.authentication}.\n */\nexport class ApiKeyManager implements IAuthenticationManager {\n  /**\n   * The current portal the user is authenticated with.\n   */\n  public readonly portal: string = \"https://www.arcgis.com/sharing/rest\";\n\n  private key: string;\n\n  /**\n   * The preferred method for creating an instance of `ApiKeyManager`.\n   */\n  public static fromKey(apiKey: string) {\n    return new ApiKeyManager({ key: apiKey });\n  }\n\n  constructor(options: IApiKeyOptions) {\n    this.key = options.key;\n  }\n\n  /**\n   * Gets a token (the API Key).\n   */\n  public getToken(url: string) {\n    return Promise.resolve(this.key);\n  }\n}\n\n/**\n * @deprecated - Use {@linkcode ApiKeyManager}.\n */ /* istanbul ignore next */\nexport function ApiKey(options: IApiKeyOptions) {\n  console.log(\n    \"DEPRECATED:, 'ApiKey' is deprecated. Use 'ApiKeyManager' instead.\"\n  );\n\n  return new ApiKeyManager(options);\n}\n","/* Copyright (c) 2017-2018 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport { ITokenRequestOptions } from \"./utils/ITokenRequestOptions.js\";\nimport { request, NODEJS_DEFAULT_REFERER_HEADER } from \"./request.js\";\nimport { IRequestOptions } from \"./utils/IRequestOptions.js\";\n\nexport interface IGenerateTokenResponse {\n  token: string;\n  expires: number;\n  ssl: boolean;\n}\n\nexport function generateToken(\n  url: string,\n  requestOptions: ITokenRequestOptions\n): Promise<IGenerateTokenResponse> {\n  const options: IRequestOptions = requestOptions;\n\n  /* istanbul ignore else */\n  if (\n    typeof window !== \"undefined\" &&\n    window.location &&\n    window.location.host\n  ) {\n    options.params.referer = window.location.host;\n  } else {\n    options.params.referer = NODEJS_DEFAULT_REFERER_HEADER;\n  }\n\n  return request(url, options);\n}\n","import { cleanUrl } from \"./utils/clean-url.js\";\n\n/**\n * Used to test if a URL is an ArcGIS Online URL\n */\nconst arcgisOnlineUrlRegex = /^https?:\\/\\/(\\S+)\\.arcgis\\.com.+/;\n\n/**\n * Used to test if a URL is production ArcGIS Online Portal\n */\nconst arcgisOnlinePortalRegex =\n  /^https?:\\/\\/(dev|devext|qa|qaext|www)\\.arcgis\\.com\\/sharing\\/rest+/;\n\n/**\n * Used to test if a URL is an ArcGIS Online Organization Portal\n */\nconst arcgisOnlineOrgPortalRegex =\n  /^https?:\\/\\/(?:[a-z0-9-]+\\.maps(dev|devext|qa|qaext)?)?.arcgis\\.com\\/sharing\\/rest/;\n\nexport function isOnline(url: string): boolean {\n  return arcgisOnlineUrlRegex.test(url);\n}\n\nexport function normalizeOnlinePortalUrl(portalUrl: string): string {\n  if (!arcgisOnlineUrlRegex.test(portalUrl)) {\n    return portalUrl;\n  }\n\n  switch (getOnlineEnvironment(portalUrl)) {\n    case \"dev\":\n      return \"https://devext.arcgis.com/sharing/rest\";\n    case \"qa\":\n      return \"https://qaext.arcgis.com/sharing/rest\";\n    default:\n      return \"https://www.arcgis.com/sharing/rest\";\n  }\n}\n\nexport function getOnlineEnvironment(url: string): string {\n  if (!arcgisOnlineUrlRegex.test(url)) {\n    return null;\n  }\n\n  const match = url.match(arcgisOnlineUrlRegex);\n  const subdomain = match[1].split(\".\").pop();\n\n  if (subdomain.includes(\"dev\")) {\n    return \"dev\";\n  }\n\n  if (subdomain.includes(\"qa\")) {\n    return \"qa\";\n  }\n\n  return \"production\";\n}\n\nexport function isFederated(\n  owningSystemUrl: string,\n  portalUrl: string\n): boolean {\n  const normalizedPortalUrl = cleanUrl(\n    normalizeOnlinePortalUrl(portalUrl)\n  ).replace(/https?:\\/\\//, \"\");\n\n  const normalizedOwningSystemUrl = cleanUrl(owningSystemUrl).replace(\n    /https?:\\/\\//,\n    \"\"\n  );\n\n  return new RegExp(normalizedOwningSystemUrl, \"i\").test(normalizedPortalUrl);\n}\n\nexport function canUseOnlineToken(\n  portalUrl: string,\n  requestUrl: string\n): boolean {\n  const portalIsOnline = isOnline(portalUrl);\n  const requestIsOnline = isOnline(requestUrl);\n  const portalEnv = getOnlineEnvironment(portalUrl);\n  const requestEnv = getOnlineEnvironment(requestUrl);\n\n  if (portalIsOnline && requestIsOnline && portalEnv === requestEnv) {\n    return true;\n  }\n\n  return false;\n}\n","/* Copyright (c) 2018-2020 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport { request } from \"./request.js\";\nimport { IRequestOptions } from \"./utils/IRequestOptions.js\";\n\nexport interface IAppAccess {\n  /**\n   * Verifies that the token is valid and the user has access to\n   * the specified app (clientId)\n   */\n  valid: boolean;\n  /**\n   * Should the app present the current user with a \"View Only\" mode\n   */\n  viewOnlyUserTypeApp: boolean;\n}\n\n/**\n * Validates that the user has access to the application\n * and if they user should be presented a \"View Only\" mode\n *\n * This is only needed/valid for Esri applications that are \"licensed\"\n * and shipped in ArcGIS Online or ArcGIS Enterprise. Most custom applications\n * should not need or use this.\n *\n * ```js\n * import { validateAppAccess } from '@esri/arcgis-rest-auth';\n *\n * return validateAppAccess('your-token', 'theClientId')\n * .then((result) => {\n *    if (!result.value) {\n *      // redirect or show some other ui\n *    } else {\n *      if (result.viewOnlyUserTypeApp) {\n *        // use this to inform your app to show a \"View Only\" mode\n *      }\n *    }\n * })\n * .catch((err) => {\n *  // two possible errors\n *  // invalid clientId: {\"error\":{\"code\":400,\"messageCode\":\"GWM_0007\",\"message\":\"Invalid request\",\"details\":[]}}\n *  // invalid token: {\"error\":{\"code\":498,\"message\":\"Invalid token.\",\"details\":[]}}\n * })\n * ```\n *\n * Note: This is only usable by Esri applications hosted on *arcgis.com, *esri.com or within\n * an ArcGIS Enterprise installation. Custom applications can not use this.\n *\n * @param token platform token\n * @param clientId application client id\n * @param portal Optional\n */\nexport function validateAppAccess(\n  token: string,\n  clientId: string,\n  portal = \"https://www.arcgis.com/sharing/rest\"\n): Promise<IAppAccess> {\n  const url = `${portal}/oauth2/validateAppAccess`;\n  const ro = {\n    method: \"POST\",\n    params: {\n      f: \"json\",\n      client_id: clientId,\n      token\n    }\n  } as IRequestOptions;\n  return request(url, ro);\n}\n","import {\n  IRequestOptions,\n  request,\n  cleanUrl,\n  ArcGISRequestError,\n  appendCustomParams\n} from \"./index.js\";\n\nexport interface IRevokeTokenOptions extends IRequestOptions {\n  /**\n   * The token or refresh token to revoke. If a refresh token is passed all access tokens generated with that refresh token are also revoked.\n   */\n  token: string;\n\n  /**\n   * The portal of the tokens to revoke. Defaults to `https://www.arcgis.com/sharing/rest`.\n   */\n  portal?: string;\n\n  /**\n   * The client id fo the application that generated the tokens. Applications can only revoke tokens they created.\n   */\n  clientId: string;\n}\n\nexport interface IRevokeTokenResponse {\n  /**\n   * Indicates if the token was revoked. A success response will also returned for invalid tokens, expired tokens or of an unsupported type of token to prevent leaking information about the provided token.\n   */\n  success: boolean;\n}\n\n/**\n * Revokes a token generated via any oAuth 2.0 method. `token` can be either a refresh token OR an access token. If you are using  {@linkcode ArcGISIdentityManager} you should use  {@linkcode ArcGISIdentityManager.destroy} instead. Cannot revoke API keys or tokens generated by {@linkcode ApplicationSession}.\n *\n * See [`revokeToken`](https://developers.arcgis.com/rest/users-groups-and-items/revoke-token.htm) on the ArcGIS REST API for more details.\n */\nexport function revokeToken(\n  requestOptions: IRevokeTokenOptions\n): Promise<IRevokeTokenResponse> {\n  const url = `${cleanUrl(\n    requestOptions.portal || \"https://www.arcgis.com/sharing/rest\"\n  )}/oauth2/revokeToken/`;\n\n  const token = requestOptions.token;\n  const clientId = requestOptions.clientId;\n\n  delete requestOptions.portal;\n  delete requestOptions.clientId;\n  delete requestOptions.token;\n\n  const options: IRequestOptions = {\n    ...requestOptions,\n    httpMethod: \"POST\",\n    params: {\n      client_id: clientId,\n      auth_token: token\n    }\n  };\n\n  return request(url, options).then((response) => {\n    if (!response.success) {\n      throw new ArcGISRequestError(\n        \"Unable to revoke token\",\n        500,\n        response,\n        url,\n        options\n      );\n    }\n    return response;\n  });\n}\n","/**\n * Encodes a `Uint8Array` to base 64. Used internally for hashing the `code_verifier` and `code_challenge` for PKCE.\n */\nexport function base64UrlEncode(value: any, win = window) {\n  /* istanbul ignore next: must pass in a mockwindow for tests so we can't cover the other branch */\n  if (!win && window) {\n    win = window;\n  }\n  return win\n    .btoa(String.fromCharCode.apply(null, value))\n    .replace(/\\+/g, \"-\") // replace + with -\n    .replace(/\\//g, \"_\") // replace / with _\n    .replace(/=+$/, \"\"); // trim trailing =\n}\n","import { base64UrlEncode } from \"./base-64-url.js\";\n\n/**\n * Utility to hash the codeVerifier using sha256\n */\nexport function generateCodeChallenge(codeVerifier: string, win = window) {\n  /* istanbul ignore next: must pass in a mockwindow for tests so we can't cover the other branch */\n  if (!win && window) {\n    win = window;\n  }\n\n  if (codeVerifier && win.isSecureContext && win.crypto && win.crypto.subtle) {\n    const encoder = new win.TextEncoder();\n    const bytes = encoder.encode(codeVerifier);\n\n    return win.crypto.subtle\n      .digest(\"SHA-256\", bytes)\n      .then((buffer) => base64UrlEncode(new Uint8Array(buffer), win));\n  }\n\n  return Promise.resolve(null);\n}\n","import { base64UrlEncode } from \"./base-64-url.js\";\n\n/**\n * Utility to generate a random string to use as our `code_verifier`\n *\n * @param win the global `window` object for accepting a mock while testing.\n */\nexport function generateRandomString(win?: any) {\n  /* istanbul ignore next: must pass in a mockwindow for tests so we can't cover the other branch */\n  if (!win && window) {\n    win = window;\n  }\n\n  const randomBytes = win.crypto.getRandomValues(new Uint8Array(32));\n  return base64UrlEncode(randomBytes);\n}\n","/* Copyright (c) 2017-2019 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport * as http from \"http\";\nimport { ArcGISAuthError, request } from \"./request.js\";\nimport { IRequestOptions } from \"./utils/IRequestOptions.js\";\nimport { IAuthenticationManager } from \"./utils/IAuthenticationManager.js\";\nimport { ITokenRequestOptions } from \"./utils/ITokenRequestOptions.js\";\nimport { decodeQueryString } from \"./utils/decode-query-string.js\";\nimport { encodeQueryString } from \"./utils/encode-query-string.js\";\nimport { IUser } from \"./types/user.js\";\nimport { generateToken } from \"./generate-token.js\";\nimport { fetchToken, IFetchTokenResponse } from \"./fetch-token.js\";\nimport { canUseOnlineToken, isFederated } from \"./federation-utils.js\";\nimport { IAppAccess, validateAppAccess } from \"./validate-app-access.js\";\nimport { cleanUrl } from \"./utils/clean-url.js\";\nimport { revokeToken } from \"./revoke-token.js\";\nimport { generateCodeChallenge } from \"./utils/generate-code-challenge.js\";\nimport { generateRandomString } from \"./utils/generate-random-string.js\";\nimport { ArcGISAccessDeniedError } from \"./utils/ArcGISAccessDeniedError.js\";\n\n/**\n * Options for {@linkcode ArcGISIdentityManager.fromToken}.\n */\nexport interface IFromTokenOptions {\n  token: string;\n  tokenExpires?: Date;\n  portal?: string;\n}\n\n/**\n * Options for {@linkcode ArcGISIdentityManager.signIn}.\n */\nexport interface ISignInOptions {\n  username: string;\n  password: string;\n  portal?: string;\n}\n\nexport type AuthenticationProvider =\n  | \"arcgis\"\n  | \"facebook\"\n  | \"google\"\n  | \"github\"\n  | \"apple\";\n\n/**\n * Represents a [credential](https://developers.arcgis.com/javascript/latest/api-reference/esri-identity-Credential.html)\n * object used to access a secure ArcGIS resource.\n */\nexport interface ICredential {\n  expires: number;\n  server: string;\n  ssl: boolean;\n  token: string;\n  userId: string;\n}\n\n/**\n * Options for static OAuth 2.0 helper methods on `ArcGISIdentityManager`.\n */\nexport interface IOAuth2Options {\n  /**\n   * Client ID of your application. Can be obtained by registering an application\n   * on [ArcGIS for Developers](https://developers.arcgis.com/documentation/core-concepts/security-and-authentication/signing-in-arcgis-online-users/#registering-your-application),\n   * [ArcGIS Online](http://doc.arcgis.com/en/arcgis-online/share-maps/add-items.htm#ESRI_SECTION1_0D1B620254F745AE84F394289F8AF44B) or on your instance of ArcGIS Enterprise.\n   */\n  clientId: string;\n\n  /**\n   * A valid URL to redirect to after a user authorizes your application. Can be set on [ArcGIS for Developers](https://developers.arcgis.com/documentation/core-concepts/security-and-authentication/signing-in-arcgis-online-users/#registering-your-application),\n   * [ArcGIS Online](http://doc.arcgis.com/en/arcgis-online/share-maps/add-items.htm#ESRI_SECTION1_0D1B620254F745AE84F394289F8AF44B) or on your instance of ArcGIS Enterprise.\n   */\n  redirectUri: string;\n\n  /**\n   * The ArcGIS Online or ArcGIS Enterprise portal you want to use for authentication. Defaults to `https://www.arcgis.com/sharing/rest` for the ArcGIS Online portal.\n   */\n  portal?: string;\n\n  /**\n   * ArcGIS Authentication is used by default. Specifying an alternative will take users directly to the corresponding provider's OAuth page.\n   */\n\n  provider?: AuthenticationProvider;\n\n  /**\n   * The requested validity in minutes for a token. Defaults to 20160 (two weeks).\n   */\n  expiration?: number;\n\n  /**\n   * Duration (in minutes) that a token will be valid. Defaults to 20160 (two weeks).\n   *\n   * @deprecated use 'expiration' instead\n   */\n  duration?: number;\n\n  /**\n   * If `true` will use the PKCE oAuth 2.0 extension spec in to authorize the user and obtain a token. A value of `false` will use the deprecated oAuth 2.0 implicit grant type.\n   *\n   * @browserOnly\n   */\n  pkce?: boolean;\n\n  /**\n   * Determines whether to open the authorization window in a new tab/window or in the current window.\n   *\n   * @browserOnly\n   */\n  popup?: boolean;\n\n  /**\n   * The window features passed to [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open) when `popup` is true. Defaults to `height=400,width=600,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes`\n   *\n   * @browserOnly\n   */\n  popupWindowFeatures?: string;\n\n  /**\n   * Duration (in minutes) that a refresh token will be valid.\n   *\n   * @nodeOnly\n   */\n  refreshTokenTTL?: number;\n\n  /**\n   * The locale assumed to render the login page.\n   *\n   * @browserOnly\n   */\n  locale?: string;\n\n  /**\n   * Sets the color theme of the oAuth 2.0 authorization screen. Will use the system preference or a light theme by default.\n   */\n  style?: \"\" | \"light\" | \"dark\";\n\n  [key: string]: any;\n}\n\n/**\n * Options for the {@linkcode ArcGISIdentityManager} constructor.\n */\nexport interface IArcGISIdentityManagerOptions {\n  /**\n   * Client ID of your application. Can be obtained by registering an application\n   * on [ArcGIS for Developers](https://developers.arcgis.com/documentation/core-concepts/security-and-authentication/signing-in-arcgis-online-users/#registering-your-application),\n   * [ArcGIS Online](http://doc.arcgis.com/en/arcgis-online/share-maps/add-items.htm#ESRI_SECTION1_0D1B620254F745AE84F394289F8AF44B) or on your instance of ArcGIS Enterprise.\n   */\n  clientId?: string;\n\n  /**\n   * A valid URL to redirect to after a user authorizes your application. Can be set on [ArcGIS for Developers](https://developers.arcgis.com/documentation/core-concepts/security-and-authentication/signing-in-arcgis-online-users/#registering-your-application),\n   * [ArcGIS Online](http://doc.arcgis.com/en/arcgis-online/share-maps/add-items.htm#ESRI_SECTION1_0D1B620254F745AE84F394289F8AF44B) or on your instance of ArcGIS Enterprise.\n   */\n  redirectUri?: string;\n\n  /**\n   * OAuth 2.0 refresh token.\n   */\n  refreshToken?: string;\n\n  /**\n   * Expiration date of the `refreshToken`\n   */\n  refreshTokenExpires?: Date;\n\n  /**\n   * The authenticated user's username. Guaranteed to be unique across ArcGIS Online or your instance of ArcGIS Enterprise.\n   */\n  username?: string;\n\n  /**\n   * Password for this user. Used in CLI apps where users cannot do OAuth 2.0.\n   */\n  password?: string;\n\n  /**\n   * OAuth 2.0 access token.\n   */\n  token?: string;\n\n  /**\n   * Expiration date for the `token`\n   */\n  tokenExpires?: Date;\n\n  /**\n   * The ArcGIS Online or ArcGIS Enterprise portal you want to use for authentication. Defaults to `https://www.arcgis.com/sharing/rest` for the ArcGIS Online portal.\n   */\n  portal?: string;\n\n  /**\n   * This value is set to true automatically if the ArcGIS Organization requires that requests be made over https.\n   */\n  ssl?: boolean;\n\n  /**\n   * ArcGIS Authentication is used by default. Specifying an alternative will take users directly to the corresponding provider's OAuth page.\n   */\n  provider?: AuthenticationProvider;\n\n  /**\n   * Duration of requested token validity in minutes. Used when requesting tokens with `username` and `password` or when validating the identity of unknown servers. Defaults to two weeks.\n   */\n  tokenDuration?: number;\n\n  /**\n   * Duration (in minutes) that a refresh token will be valid.\n   */\n  refreshTokenTTL?: number;\n\n  /**\n   * An unfederated ArcGIS Server instance known to recognize credentials supplied manually.\n   * ```js\n   * {\n   *   server: \"https://sampleserver6.arcgisonline.com/arcgis\",\n   *   token: \"SOSlV3v..\",\n   *   tokenExpires: new Date(1545415669763)\n   * }\n   * ```\n   */\n  server?: string;\n}\n\n/**\n * Used to authenticate both ArcGIS Online and ArcGIS Enterprise users. `ArcGISIdentityManager` includes helper methods for [OAuth 2.0](/arcgis-rest-js/guides/browser-authentication/) in both browser and server applications.\n *\n * **It is not recommended to construct `ArcGISIdentityManager` directly**. Instead there are several static methods used for specific workflows. The 2 primary workflows relate to oAuth 2.0:\n *\n * * {@linkcode ArcGISIdentityManager.beginOAuth2} + {@linkcode ArcGISIdentityManager.completeOAuth2} - for oAuth 2.0 in browser-only environment.\n * * {@linkcode ArcGISIdentityManager.authorize} + {@linkcode ArcGISIdentityManager.exchangeAuthorizationCode} - for oAuth 2.0 for server-enabled application.\n *\n * Other more specialized helpers for less common workflows also exist:\n *\n * * {@linkcode ArcGISIdentityManager.enablePostMessageAuth} + {@linkcode ArcGISIdentityManager.fromParent} - For when your application needs to pass authentication details between different pages embedded in iframes.\n * * {@linkcode ArcGISIdentityManager.fromToken} - When you have an existing token from another source and would like create an `ArcGISIdentityManager` instance.\n * * {@linkcode ArcGISIdentityManager.fromCredential} - For creating  an `ArcGISIdentityManager` instance from a `Credentials` object in the ArcGIS JS API `IdentityManager`\n * * {@linkcode ArcGISIdentityManager.signIn} - Authenticate directly with a users username and password.\n *\n * Once a manager is created there are additional utilities:\n *\n * * {@linkcode ArcGISIdentityManager.serialize} can be used to create a JSON object representing an instance of `ArcGISIdentityManager`\n * * {@linkcode ArcGISIdentityManager.deserialize} will create a new `ArcGISIdentityManager` from a JSON object created with {@linkcode ArcGISIdentityManager.serialize}\n * * {@linkcode ArcGISIdentityManager.destroy} or {@linkcode ArcGISIdentityManager.signOut} will invalidate any tokens in use by the  `ArcGISIdentityManager`.\n */\nexport class ArcGISIdentityManager implements IAuthenticationManager {\n  /**\n   * The current ArcGIS Online or ArcGIS Enterprise `token`.\n   */\n  get token() {\n    return this._token;\n  }\n\n  /**\n   * The expiration time of the current `token`.\n   */\n  get tokenExpires() {\n    return this._tokenExpires;\n  }\n\n  /**\n   * The current token to ArcGIS Online or ArcGIS Enterprise.\n   */\n  get refreshToken() {\n    return this._refreshToken;\n  }\n\n  /**\n   * The expiration time of the current `refreshToken`.\n   */\n  get refreshTokenExpires() {\n    return this._refreshTokenExpires;\n  }\n\n  /**\n   * The currently authenticated user.\n   */\n  get username() {\n    if (this._username) {\n      return this._username;\n    }\n\n    if (this._user && this._user.username) {\n      return this._user.username;\n    }\n  }\n\n  /**\n   * Returns `true` if these credentials can be refreshed and `false` if it cannot.\n   */\n  get canRefresh() {\n    if (this.username && this.password) {\n      return true;\n    }\n\n    if (this.clientId && this.refreshToken) {\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Begins a new browser-based OAuth 2.0 sign in. If `options.popup` is `true` the\n   * authentication window will open in a new tab/window. Otherwise, the user will be redirected to the authorization page in their current tab/window and the function will return `undefined`.\n   *\n   * @browserOnly\n   */\n  public static beginOAuth2(\n    options: IOAuth2Options,\n    win?: any\n  ): Promise<ArcGISIdentityManager> | undefined {\n    /* istanbul ignore next: must pass in a mockwindow for tests so we can't cover the other branch */\n    if (!win && window) {\n      win = window;\n    }\n\n    const {\n      portal,\n      provider,\n      clientId,\n      expiration,\n      redirectUri,\n      popup,\n      popupWindowFeatures,\n      locale,\n      params,\n      style,\n      pkce\n    }: IOAuth2Options = {\n      ...{\n        portal: \"https://www.arcgis.com/sharing/rest\",\n        provider: \"arcgis\",\n        expiration: 20160,\n        popup: true,\n        popupWindowFeatures:\n          \"height=400,width=600,menubar=no,location=yes,resizable=yes,scrollbars=yes,status=yes\",\n        state: options.clientId,\n        locale: \"\",\n        style: \"\",\n        pkce: true\n      },\n      ...options\n    };\n\n    /**\n     * Generate a  random string for the `state` param and store it in local storage. This is used\n     * to validate that all parts of the oAuth process were performed on the same client.\n     */\n    const stateId = generateRandomString(win);\n    const stateStorageKey = `ARCGIS_REST_JS_AUTH_STATE_${clientId}`;\n\n    win.localStorage.setItem(stateStorageKey, stateId);\n\n    // Start setting up the URL to the authorization screen.\n    let authorizeUrl = `${cleanUrl(portal)}/oauth2/authorize`;\n    const authorizeUrlParams: any = {\n      client_id: clientId,\n      response_type: pkce ? \"code\" : \"token\",\n      expiration: expiration,\n      redirect_uri: redirectUri,\n      state: JSON.stringify({\n        id: stateId,\n        originalUrl: win.location.href // this is used to reset the URL back the original URL upon return\n      }),\n      locale: locale,\n      style: style\n    };\n\n    // If we are authorizing through a specific social provider update the params and base URL.\n    if (provider !== \"arcgis\") {\n      authorizeUrl = `${cleanUrl(portal)}/oauth2/social/authorize`;\n      authorizeUrlParams.socialLoginProviderName = provider;\n      authorizeUrlParams.autoAccountCreateForSocial = true;\n    }\n\n    /**\n     * set a value that will be set to a promise which will later resolve when we are ready\n     * to send users to the authorization page.\n     */\n    let setupAuth;\n\n    if (pkce) {\n      /**\n       * If we are authenticating with PKCE we need to generate the code challenge which is\n       * async so we generate the code challenge and assign the resulting Promise to `setupAuth`\n       */\n      const codeVerifier = generateRandomString(win);\n      const codeVerifierStorageKey = `ARCGIS_REST_JS_CODE_VERIFIER_${clientId}`;\n\n      win.localStorage.setItem(codeVerifierStorageKey, codeVerifier);\n\n      setupAuth = generateCodeChallenge(codeVerifier, win).then(function (\n        codeChallenge\n      ) {\n        authorizeUrlParams.code_challenge_method = codeChallenge\n          ? \"S256\"\n          : \"plain\";\n\n        authorizeUrlParams.code_challenge = codeChallenge\n          ? codeChallenge\n          : codeVerifier;\n      });\n    } else {\n      /**\n       * If we aren't authenticating with PKCE we can just assign a resolved promise to `setupAuth`\n       */\n      setupAuth = Promise.resolve();\n    }\n\n    /**\n     * Once we are done setting up with (for PKCE) we can start the auth process.\n     */\n    return setupAuth.then(() => {\n      // combine the authorize URL and params\n      authorizeUrl = `${authorizeUrl}?${encodeQueryString(authorizeUrlParams)}`;\n\n      // append additional params passed by the user\n      if (params) {\n        authorizeUrl = `${authorizeUrl}&${encodeQueryString(params)}`;\n      }\n\n      if (popup) {\n        // If we are authenticating a popup we need to return a Promise that will resolve to an ArcGISIdentityManager later.\n        return new Promise((resolve, reject) => {\n          // Add an event listener to listen for when a user calls `ArcGISIdentityManager.completeOAuth2()` in the popup.\n          win.addEventListener(\n            `arcgis-rest-js-popup-auth-${clientId}`,\n            (e: CustomEvent<any>) => {\n              if (e.detail.error === \"access_denied\") {\n                const error = new ArcGISAccessDeniedError();\n                reject(error);\n                return error;\n              }\n\n              if (e.detail.error) {\n                const error = new ArcGISAuthError(\n                  e.detail.errorMessage,\n                  e.detail.error\n                );\n                reject(error);\n                return error;\n              }\n\n              resolve(\n                new ArcGISIdentityManager({\n                  clientId,\n                  portal,\n                  ssl: e.detail.ssl,\n                  token: e.detail.token,\n                  tokenExpires: e.detail.expires,\n                  username: e.detail.username,\n                  refreshToken: e.detail.refreshToken,\n                  refreshTokenExpires: e.detail.refreshTokenExpires\n                })\n              );\n            },\n            {\n              once: true\n            }\n          );\n\n          // open the popup\n          win.open(authorizeUrl, \"oauth-window\", popupWindowFeatures);\n\n          win.dispatchEvent(new CustomEvent(\"arcgis-rest-js-popup-auth-start\"));\n        });\n      } else {\n        // If we aren't authenticating with a popup just send the user to the authorization page.\n        win.location.href = authorizeUrl;\n        return undefined;\n      }\n    });\n  }\n\n  /**\n   * Completes a browser-based OAuth 2.0 sign in. If `options.popup` is `true` the user\n   * will be returned to the previous window and the popup will close. Otherwise a new `ArcGISIdentityManager` will be returned. You must pass the same values for `clientId`, `popup`, `portal`, and `pkce` as you used in `beginOAuth2()`.\n   *\n   * @browserOnly\n   */\n  public static completeOAuth2(options: IOAuth2Options, win?: any) {\n    /* istanbul ignore next: must pass in a mockwindow for tests so we can't cover the other branch */\n    if (!win && window) {\n      win = window;\n    }\n\n    // pull out necessary options\n    const { portal, clientId, popup, pkce }: IOAuth2Options = {\n      ...{\n        portal: \"https://www.arcgis.com/sharing/rest\",\n        popup: true,\n        pkce: true\n      },\n      ...options\n    };\n\n    // pull the saved state id out of local storage\n    const stateStorageKey = `ARCGIS_REST_JS_AUTH_STATE_${clientId}`;\n    const stateId = win.localStorage.getItem(stateStorageKey);\n\n    // get the params provided by the server and compare the server state with the client saved state\n    const params = decodeQueryString(\n      pkce\n        ? win.location.search.replace(/^\\?/, \"\")\n        : win.location.hash.replace(/^#/, \"\")\n    );\n\n    const state = params && params.state ? JSON.parse(params.state) : undefined;\n\n    function reportError(\n      errorMessage: string,\n      error: string,\n      originalUrl?: string\n    ) {\n      win.localStorage.removeItem(stateStorageKey);\n\n      if (popup && win.opener) {\n        win.opener.dispatchEvent(\n          new CustomEvent(`arcgis-rest-js-popup-auth-${clientId}`, {\n            detail: {\n              error,\n              errorMessage\n            }\n          })\n        );\n\n        win.close();\n        return;\n      }\n\n      if (originalUrl) {\n        win.history.replaceState(win.history.state, \"\", originalUrl);\n      }\n\n      if (error === \"access_denied\") {\n        return Promise.reject(new ArcGISAccessDeniedError());\n      }\n\n      return Promise.reject(new ArcGISAuthError(errorMessage, error));\n    }\n\n    // create a function to create the final ArcGISIdentityManager from the token info.\n    function createManager(\n      oauthInfo: IFetchTokenResponse,\n      originalUrl: string\n    ) {\n      win.localStorage.removeItem(stateStorageKey);\n\n      if (popup && win.opener) {\n        win.opener.dispatchEvent(\n          new CustomEvent(`arcgis-rest-js-popup-auth-${clientId}`, {\n            detail: {\n              ...oauthInfo\n            }\n          })\n        );\n\n        win.close();\n        return;\n      }\n\n      win.history.replaceState(win.history.state, \"\", originalUrl);\n\n      return new ArcGISIdentityManager({\n        clientId,\n        portal,\n        ssl: oauthInfo.ssl,\n        token: oauthInfo.token,\n        tokenExpires: oauthInfo.expires,\n        username: oauthInfo.username,\n        refreshToken: oauthInfo.refreshToken,\n        refreshTokenExpires: oauthInfo.refreshTokenExpires\n      });\n    }\n\n    if (!stateId || !state) {\n      return reportError(\n        \"No authentication state was found, call `ArcGISIdentityManager.beginOAuth2(...)` to start the authentication process.\",\n        \"no-auth-state\"\n      );\n    }\n\n    if (state.id !== stateId) {\n      return reportError(\n        \"Saved client state did not match server sent state.\",\n        \"mismatched-auth-state\"\n      );\n    }\n\n    if (params.error) {\n      const error = params.error;\n      const errorMessage = params.error_description || \"Unknown error\";\n\n      return reportError(errorMessage, error, state.originalUrl);\n    }\n    /**\n     * If we are using PKCE the authorization code will be in the query params.\n     * For implicit grants the token will be in the hash.\n     */\n    if (pkce && params.code) {\n      const tokenEndpoint = cleanUrl(`${portal}/oauth2/token/`);\n\n      const codeVerifierStorageKey = `ARCGIS_REST_JS_CODE_VERIFIER_${clientId}`;\n      const codeVerifier = win.localStorage.getItem(codeVerifierStorageKey);\n      win.localStorage.removeItem(codeVerifierStorageKey);\n\n      // exchange our auth code for a token + refresh token\n      return fetchToken(tokenEndpoint, {\n        httpMethod: \"POST\",\n        params: {\n          client_id: clientId,\n          code_verifier: codeVerifier,\n          grant_type: \"authorization_code\",\n          redirect_uri: location.href.replace(location.search, \"\"),\n          code: params.code\n        }\n      })\n        .then((tokenResponse) => {\n          return createManager(\n            { ...tokenResponse, ...state },\n            state.originalUrl\n          );\n        })\n        .catch((e) => {\n          return reportError(e.message, e.error, state.originalUrl);\n        });\n    }\n\n    if (!pkce && params.access_token) {\n      return Promise.resolve(\n        createManager(\n          {\n            token: params.access_token,\n            expires: new Date(\n              Date.now() + parseInt(params.expires_in, 10) * 1000\n            ),\n            ssl: params.ssl === \"true\",\n            username: params.username,\n            ...state\n          },\n          state.originalUrl\n        )\n      );\n    }\n\n    return reportError(\"Unknown error\", \"oauth-error\", state.originalUrl);\n  }\n\n  /**\n   * Request credentials information from the parent application\n   *\n   * When an application is embedded into another application via an IFrame, the embedded app can\n   * use `window.postMessage` to request credentials from the host application. This function wraps\n   * that behavior.\n   *\n   * The ArcGIS API for Javascript has this built into the Identity Manager as of the 4.19 release.\n   *\n   * Note: The parent application will not respond if the embedded app's origin is not:\n   * - the same origin as the parent or *.arcgis.com (JSAPI)\n   * - in the list of valid child origins (REST-JS)\n   *\n   *\n   * @param parentOrigin origin of the parent frame. Passed into the embedded application as `parentOrigin` query param\n   * @browserOnly\n   */\n  public static fromParent(parentOrigin: string, win?: any): Promise<any> {\n    /* istanbul ignore next: must pass in a mockwindow for tests so we can't cover the other branch */\n    if (!win && window) {\n      win = window;\n    }\n    // Declare handler outside of promise scope so we can detach it\n    let handler: (event: any) => void;\n    // return a promise that will resolve when the handler receives\n    // session information from the correct origin\n    return new Promise((resolve, reject) => {\n      // create an event handler that just wraps the parentMessageHandler\n      handler = (event: any) => {\n        // ensure we only listen to events from the parent\n        if (event.source === win.parent && event.data) {\n          try {\n            return resolve(ArcGISIdentityManager.parentMessageHandler(event));\n          } catch (err) {\n            return reject(err);\n          }\n        }\n      };\n      // add listener\n      win.addEventListener(\"message\", handler, false);\n      win.parent.postMessage(\n        { type: \"arcgis:auth:requestCredential\" },\n        parentOrigin\n      );\n    }).then((manager) => {\n      win.removeEventListener(\"message\", handler, false);\n      return manager;\n    });\n  }\n\n  /**\n   * Begins a new server-based OAuth 2.0 sign in. This will redirect the user to\n   * the ArcGIS Online or ArcGIS Enterprise authorization page.\n   *\n   * @nodeOnly\n   */\n  public static authorize(\n    options: IOAuth2Options,\n    response: http.ServerResponse\n  ) {\n    const { portal, clientId, expiration, redirectUri }: IOAuth2Options = {\n      ...{ portal: \"https://arcgis.com/sharing/rest\", expiration: 20160 },\n      ...options\n    };\n\n    response.writeHead(301, {\n      Location: `${portal}/oauth2/authorize?client_id=${clientId}&expiration=${expiration}&response_type=code&redirect_uri=${encodeURIComponent(\n        redirectUri\n      )}`\n    });\n\n    response.end();\n  }\n\n  /**\n   * Completes the server-based OAuth 2.0 sign in process by exchanging the `authorizationCode`\n   * for a `access_token`.\n   *\n   * @nodeOnly\n   */\n  public static exchangeAuthorizationCode(\n    options: IOAuth2Options,\n    authorizationCode: string\n  ): Promise<ArcGISIdentityManager> {\n    const { portal, clientId, redirectUri, refreshTokenTTL }: IOAuth2Options = {\n      ...{\n        portal: \"https://www.arcgis.com/sharing/rest\",\n        refreshTokenTTL: 20160\n      },\n      ...options\n    };\n\n    return fetchToken(`${portal}/oauth2/token`, {\n      params: {\n        grant_type: \"authorization_code\",\n        client_id: clientId,\n        redirect_uri: redirectUri,\n        code: authorizationCode\n      }\n    }).then((response) => {\n      return new ArcGISIdentityManager({\n        clientId,\n        portal,\n        ssl: response.ssl,\n        redirectUri,\n        refreshToken: response.refreshToken,\n        refreshTokenTTL,\n        refreshTokenExpires: new Date(\n          Date.now() + (refreshTokenTTL - 1) * 60 * 1000\n        ),\n        token: response.token,\n        tokenExpires: response.expires,\n        username: response.username\n      });\n    });\n  }\n\n  public static deserialize(str: string) {\n    const options = JSON.parse(str);\n    return new ArcGISIdentityManager({\n      clientId: options.clientId,\n      refreshToken: options.refreshToken,\n      refreshTokenExpires: new Date(options.refreshTokenExpires),\n      username: options.username,\n      password: options.password,\n      token: options.token,\n      tokenExpires: new Date(options.tokenExpires),\n      portal: options.portal,\n      ssl: options.ssl,\n      tokenDuration: options.tokenDuration,\n      redirectUri: options.redirectUri,\n      refreshTokenTTL: options.refreshTokenTTL,\n      server: options.server\n    });\n  }\n\n  /**\n   * Translates authentication from the format used in the [ArcGIS API for JavaScript](https://developers.arcgis.com/javascript/).\n   *\n   * ```js\n   * ArcGISIdentityManager.fromCredential({\n   *   userId: \"jsmith\",\n   *   token: \"secret\"\n   * });\n   * ```\n   *\n   * @returns ArcGISIdentityManager\n   */\n  public static fromCredential(credential: ICredential) {\n    // At ArcGIS Online 9.1, credentials no longer include the ssl and expires properties\n    // Here, we provide default values for them to cover this condition\n    const ssl = typeof credential.ssl !== \"undefined\" ? credential.ssl : true;\n    const expires = credential.expires || Date.now() + 7200000; /* 2 hours */\n\n    return new ArcGISIdentityManager({\n      portal: credential.server.includes(\"sharing/rest\")\n        ? credential.server\n        : credential.server + `/sharing/rest`,\n      ssl,\n      token: credential.token,\n      username: credential.userId,\n      tokenExpires: new Date(expires)\n    });\n  }\n\n  /**\n   * Handle the response from the parent\n   * @param event DOM Event\n   */\n  private static parentMessageHandler(event: any): ArcGISIdentityManager {\n    if (event.data.type === \"arcgis:auth:credential\") {\n      return ArcGISIdentityManager.fromCredential(event.data.credential);\n    }\n    if (event.data.type === \"arcgis:auth:error\") {\n      const err = new Error(event.data.error.message);\n      err.name = event.data.error.name;\n      throw err;\n    } else {\n      throw new Error(\"Unknown message type.\");\n    }\n  }\n\n  /**\n   * Revokes all active tokens for a provided {@linkcode ArcGISIdentityManager}. The can be considered the equivalent to signing the user out of your application.\n   */\n  public static destroy(manager: ArcGISIdentityManager) {\n    return revokeToken({\n      clientId: manager.clientId,\n      portal: manager.portal,\n      token: manager.refreshToken || manager.token\n    });\n  }\n\n  /**\n   * Create a  {@linkcode ArcGISIdentityManager} from an existing token. Useful for when you have a users token from a different authentication system and want to get a  {@linkcode ArcGISIdentityManager}.\n   */\n  public static fromToken(\n    options: IFromTokenOptions\n  ): Promise<ArcGISIdentityManager> {\n    const manager = new ArcGISIdentityManager(options);\n\n    return manager.getUser().then(() => {\n      return manager;\n    });\n  }\n\n  /**\n   * Initialize a {@linkcode ArcGISIdentityManager} with a users `username` and `password`. **This method is intended ONLY for applications without a user interface such as CLI tools.**.\n   *\n   * If possible you should use {@linkcode ArcGISIdentityManager.beginOAuth2} to authenticate users in a browser or {@linkcode ArcGISIdentityManager.authorize} for authenticating users with a web server.\n   */\n  public static signIn(options: ISignInOptions) {\n    const manager = new ArcGISIdentityManager(options);\n\n    return manager.getUser().then(() => {\n      return manager;\n    });\n  }\n\n  /**\n   * Client ID being used for authentication if provided in the `constructor`.\n   */\n  public readonly clientId: string;\n\n  /**\n   * The currently authenticated user's password if provided in the `constructor`.\n   */\n  public readonly password: string;\n\n  /**\n   * The current portal the user is authenticated with.\n   */\n  public readonly portal: string;\n\n  /**\n   * This value is set to true automatically if the ArcGIS Organization requires that requests be made over https.\n   */\n  public readonly ssl: boolean;\n\n  /**\n   * The authentication provider to use.\n   */\n  public readonly provider: AuthenticationProvider;\n\n  /**\n   * Determines how long new tokens requested are valid.\n   */\n  public readonly tokenDuration: number;\n\n  /**\n   * A valid redirect URI for this application if provided in the `constructor`.\n   */\n  public readonly redirectUri: string;\n\n  /**\n   * Duration of new OAuth 2.0 refresh token validity (in minutes).\n   */\n  public readonly refreshTokenTTL: number;\n\n  /**\n   * An unfederated ArcGIS Server instance known to recognize credentials supplied manually.\n   * ```js\n   * {\n   *   server: \"https://sampleserver6.arcgisonline.com/arcgis\",\n   *   token: \"SOSlV3v..\",\n   *   tokenExpires: new Date(1545415669763)\n   * }\n   * ```\n   */\n  public readonly server: string;\n\n  /**\n   * Hydrated by a call to [getUser()](#getUser-summary).\n   */\n  private _user: IUser;\n\n  /**\n   * Hydrated by a call to [getPortal()](#getPortal-summary).\n   */\n  private _portalInfo: any;\n\n  private _token: string;\n  private _tokenExpires: Date;\n  private _refreshToken: string;\n  private _refreshTokenExpires: Date;\n  private _pendingUserRequest: Promise<IUser>;\n  private _pendingPortalRequest: Promise<any>;\n\n  /**\n   * Internal object to keep track of pending token requests. Used to prevent\n   *  duplicate token requests.\n   */\n  private _pendingTokenRequests: {\n    [key: string]: Promise<string>;\n  };\n\n  private _username: string;\n\n  /**\n   * Internal list of tokens to 3rd party servers (federated servers) that have\n   *  been created via `generateToken`. The object key is the root URL of the server.\n   */\n  private federatedServers: {\n    [key: string]: {\n      token: string;\n      expires: Date;\n    };\n  };\n\n  /**\n   * Internal list of 3rd party domains that should receive all cookies (credentials: \"include\").\n   * Used to for PKI and IWA workflows in high security environments.\n   */\n  private trustedDomains: string[];\n\n  private _hostHandler: any;\n\n  constructor(options: IArcGISIdentityManagerOptions) {\n    this.clientId = options.clientId;\n    this._refreshToken = options.refreshToken;\n    this._refreshTokenExpires = options.refreshTokenExpires;\n    this._username = options.username;\n    this.password = options.password;\n    this._token = options.token;\n    this._tokenExpires = options.tokenExpires;\n    this.portal = options.portal\n      ? cleanUrl(options.portal)\n      : \"https://www.arcgis.com/sharing/rest\";\n    this.ssl = options.ssl;\n    this.provider = options.provider || \"arcgis\";\n    this.tokenDuration = options.tokenDuration || 20160;\n    this.redirectUri = options.redirectUri;\n    this.refreshTokenTTL = options.refreshTokenTTL || 20160;\n    this.server = options.server;\n\n    this.federatedServers = {};\n    this.trustedDomains = [];\n\n    // if a non-federated server was passed explicitly, it should be trusted.\n    if (options.server) {\n      // if the url includes more than '/arcgis/', trim the rest\n      const root = this.getServerRootUrl(options.server);\n\n      this.federatedServers[root] = {\n        token: options.token,\n        expires: options.tokenExpires\n      };\n    }\n    this._pendingTokenRequests = {};\n  }\n\n  /**\n   * Returns authentication in a format useable in the [ArcGIS API for JavaScript](https://developers.arcgis.com/javascript/).\n   *\n   * ```js\n   * esriId.registerToken(manager.toCredential());\n   * ```\n   *\n   * @returns ICredential\n   */\n  public toCredential(): ICredential {\n    return {\n      expires: this.tokenExpires.getTime(),\n      server: this.portal,\n      ssl: this.ssl,\n      token: this.token,\n      userId: this.username\n    };\n  }\n\n  /**\n   * Returns information about the currently logged in [user](https://developers.arcgis.com/rest/users-groups-and-items/user.htm). Subsequent calls will *not* result in additional web traffic.\n   *\n   * ```js\n   * manager.getUser()\n   *   .then(response => {\n   *     console.log(response.role); // \"org_admin\"\n   *   })\n   * ```\n   *\n   * @param requestOptions - Options for the request. NOTE: `rawResponse` is not supported by this operation.\n   * @returns A Promise that will resolve with the data from the response.\n   */\n  public getUser(requestOptions?: IRequestOptions): Promise<IUser> {\n    if (this._pendingUserRequest) {\n      return this._pendingUserRequest;\n    } else if (this._user) {\n      return Promise.resolve(this._user);\n    } else {\n      const url = `${this.portal}/community/self`;\n\n      const options = {\n        httpMethod: \"GET\",\n        authentication: this,\n        ...requestOptions,\n        rawResponse: false\n      } as IRequestOptions;\n\n      this._pendingUserRequest = request(url, options).then((response) => {\n        this._user = response;\n        this._pendingUserRequest = null;\n        return response;\n      });\n\n      return this._pendingUserRequest;\n    }\n  }\n\n  /**\n   * Returns information about the currently logged in user's [portal](https://developers.arcgis.com/rest/users-groups-and-items/portal-self.htm). Subsequent calls will *not* result in additional web traffic.\n   *\n   * ```js\n   * manager.getPortal()\n   *   .then(response => {\n   *     console.log(portal.name); // \"City of ...\"\n   *   })\n   * ```\n   *\n   * @param requestOptions - Options for the request. NOTE: `rawResponse` is not supported by this operation.\n   * @returns A Promise that will resolve with the data from the response.\n   */\n  public getPortal(requestOptions?: IRequestOptions): Promise<any> {\n    if (this._pendingPortalRequest) {\n      return this._pendingPortalRequest;\n    } else if (this._portalInfo) {\n      return Promise.resolve(this._portalInfo);\n    } else {\n      const url = `${this.portal}/portals/self`;\n\n      const options = {\n        httpMethod: \"GET\",\n        authentication: this,\n        ...requestOptions,\n        rawResponse: false\n      } as IRequestOptions;\n\n      this._pendingPortalRequest = request(url, options).then((response) => {\n        this._portalInfo = response;\n        this._pendingPortalRequest = null;\n        return response;\n      });\n\n      return this._pendingPortalRequest;\n    }\n  }\n\n  /**\n   * Returns the username for the currently logged in [user](https://developers.arcgis.com/rest/users-groups-and-items/user.htm). Subsequent calls will *not* result in additional web traffic. This is also used internally when a username is required for some requests but is not present in the options.\n   *\n   *    * ```js\n   * manager.getUsername()\n   *   .then(response => {\n   *     console.log(response); // \"casey_jones\"\n   *   })\n   * ```\n   */\n  public getUsername() {\n    if (this.username) {\n      return Promise.resolve(this.username);\n    } else {\n      return this.getUser().then((user) => {\n        return user.username;\n      });\n    }\n  }\n\n  /**\n   * Gets an appropriate token for the given URL. If `portal` is ArcGIS Online and\n   * the request is to an ArcGIS Online domain `token` will be used. If the request\n   * is to the current `portal` the current `token` will also be used. However if\n   * the request is to an unknown server we will validate the server with a request\n   * to our current `portal`.\n   */\n  public getToken(url: string, requestOptions?: ITokenRequestOptions) {\n    if (canUseOnlineToken(this.portal, url)) {\n      return this.getFreshToken(requestOptions);\n    } else if (new RegExp(this.portal, \"i\").test(url)) {\n      return this.getFreshToken(requestOptions);\n    } else {\n      return this.getTokenForServer(url, requestOptions);\n    }\n  }\n\n  /**\n   * Get application access information for the current user\n   * see `validateAppAccess` function for details\n   *\n   * @param clientId application client id\n   */\n  public validateAppAccess(clientId: string): Promise<IAppAccess> {\n    return this.getToken(this.portal).then((token) => {\n      return validateAppAccess(token, clientId);\n    });\n  }\n\n  public toJSON(): IArcGISIdentityManagerOptions {\n    return {\n      clientId: this.clientId,\n      refreshToken: this.refreshToken,\n      refreshTokenExpires: this.refreshTokenExpires,\n      username: this.username,\n      password: this.password,\n      token: this.token,\n      tokenExpires: this.tokenExpires,\n      portal: this.portal,\n      ssl: this.ssl,\n      tokenDuration: this.tokenDuration,\n      redirectUri: this.redirectUri,\n      refreshTokenTTL: this.refreshTokenTTL,\n      server: this.server\n    };\n  }\n\n  public serialize() {\n    return JSON.stringify(this);\n  }\n  /**\n   * For a \"Host\" app that embeds other platform apps via iframes, after authenticating the user\n   * and creating a ArcGISIdentityManager, the app can then enable \"post message\" style authentication by calling\n   * this method.\n   *\n   * Internally this adds an event listener on window for the `message` event\n   *\n   * @param validChildOrigins Array of origins that are allowed to request authentication from the host app\n   */\n  public enablePostMessageAuth(validChildOrigins: string[], win?: any): any {\n    /* istanbul ignore next: must pass in a mockwindow for tests so we can't cover the other branch */\n    if (!win && window) {\n      win = window;\n    }\n    this._hostHandler = this.createPostMessageHandler(validChildOrigins);\n    win.addEventListener(\"message\", this._hostHandler, false);\n  }\n\n  /**\n   * For a \"Host\" app that has embedded other platform apps via iframes, when the host needs\n   * to transition routes, it should call `ArcGISIdentityManager.disablePostMessageAuth()` to remove\n   * the event listener and prevent memory leaks\n   */\n  public disablePostMessageAuth(win?: any) {\n    /* istanbul ignore next: must pass in a mockwindow for tests so we can't cover the other branch */\n    if (!win && window) {\n      win = window;\n    }\n    win.removeEventListener(\"message\", this._hostHandler, false);\n  }\n\n  /**\n   * Manually refreshes the current `token` and `tokenExpires`.\n   */\n  public refreshCredentials(requestOptions?: ITokenRequestOptions) {\n    // make sure subsequent calls to getUser() don't returned cached metadata\n    this._user = null;\n\n    if (this.username && this.password) {\n      return this.refreshWithUsernameAndPassword(requestOptions);\n    }\n\n    if (this.clientId && this.refreshToken) {\n      return this.refreshWithRefreshToken();\n    }\n\n    return Promise.reject(new ArcGISAuthError(\"Unable to refresh token.\"));\n  }\n\n  /**\n   * Determines the root of the ArcGIS Server or Portal for a given URL.\n   *\n   * @param url the URl to determine the root url for.\n   */\n  public getServerRootUrl(url: string) {\n    const [root] = cleanUrl(url).split(\n      /\\/rest(\\/admin)?\\/services(?:\\/|#|\\?|$)/\n    );\n    const [match, protocol, domainAndPath] = root.match(/(https?:\\/\\/)(.+)/);\n    const [domain, ...path] = domainAndPath.split(\"/\");\n\n    // only the domain is lowercased because in some cases an org id might be\n    // in the path which cannot be lowercased.\n    return `${protocol}${domain.toLowerCase()}/${path.join(\"/\")}`;\n  }\n\n  /**\n   * Returns the proper [`credentials`] option for `fetch` for a given domain.\n   * See [trusted server](https://enterprise.arcgis.com/en/portal/latest/administer/windows/configure-security.htm#ESRI_SECTION1_70CC159B3540440AB325BE5D89DBE94A).\n   * Used internally by underlying request methods to add support for specific security considerations.\n   *\n   * @param url The url of the request\n   * @returns \"include\" or \"same-origin\"\n   */\n  public getDomainCredentials(url: string): RequestCredentials {\n    if (!this.trustedDomains || !this.trustedDomains.length) {\n      return \"same-origin\";\n    }\n\n    return this.trustedDomains.some((domainWithProtocol) => {\n      return url.startsWith(domainWithProtocol);\n    })\n      ? \"include\"\n      : \"same-origin\";\n  }\n\n  /**\n   * Convenience method for {@linkcode ArcGISIdentityManager.destroy} for this instance of `ArcGISIdentityManager`\n   */\n  public signOut() {\n    return ArcGISIdentityManager.destroy(this);\n  }\n\n  /**\n   * Return a function that closes over the validOrigins array and\n   * can be used as an event handler for the `message` event\n   *\n   * @param validOrigins Array of valid origins\n   */\n  private createPostMessageHandler(\n    validOrigins: string[]\n  ): (event: any) => void {\n    // return a function that closes over the validOrigins and\n    // has access to the credential\n    return (event: any) => {\n      // Verify that the origin is valid\n      // Note: do not use regex's here. validOrigins is an array so we're checking that the event's origin\n      // is in the array via exact match. More info about avoiding postMessage xss issues here\n      // https://jlajara.gitlab.io/web/2020/07/17/Dom_XSS_PostMessage_2.html#tipsbypasses-in-postmessage-vulnerabilities\n      const isValidOrigin = validOrigins.indexOf(event.origin) > -1;\n      // JSAPI handles this slightly differently - instead of checking a list, it will respond if\n      // event.origin === window.location.origin || event.origin.endsWith('.arcgis.com')\n      // For Hub, and to enable cross domain debugging with port's in urls, we are opting to\n      // use a list of valid origins\n\n      // Ensure the message type is something we want to handle\n      const isValidType = event.data.type === \"arcgis:auth:requestCredential\";\n      // Ensure we don't pass an expired session forward\n      const isTokenValid = this.tokenExpires.getTime() > Date.now();\n\n      if (isValidOrigin && isValidType) {\n        let msg = {};\n        if (isTokenValid) {\n          const credential = this.toCredential();\n          // the following line allows us to conform to our spec without changing other depended-on functionality\n          // https://github.com/Esri/arcgis-rest-js/blob/master/packages/arcgis-rest-request/post-message-auth-spec.md#arcgisauthcredential\n          credential.server = credential.server.replace(\"/sharing/rest\", \"\");\n          msg = {\n            type: \"arcgis:auth:credential\",\n            credential\n          };\n        } else {\n          msg = {\n            type: \"arcgis:auth:error\",\n            error: {\n              name: \"tokenExpiredError\",\n              message:\n                \"Token was expired, and not returned to the child application\"\n            }\n          };\n        }\n\n        event.source.postMessage(msg, event.origin);\n      }\n    };\n  }\n\n  /**\n   * Validates that a given URL is properly federated with our current `portal`.\n   * Attempts to use the internal `federatedServers` cache first.\n   */\n  private getTokenForServer(\n    url: string,\n    requestOptions?: ITokenRequestOptions\n  ) {\n    // requests to /rest/services/ and /rest/admin/services/ are both valid\n    // Federated servers may have inconsistent casing, so lowerCase it\n    const root = this.getServerRootUrl(url);\n    const existingToken = this.federatedServers[root];\n\n    if (\n      existingToken &&\n      existingToken.expires &&\n      existingToken.expires.getTime() > Date.now()\n    ) {\n      return Promise.resolve(existingToken.token);\n    }\n\n    if (this._pendingTokenRequests[root]) {\n      return this._pendingTokenRequests[root];\n    }\n\n    this._pendingTokenRequests[root] = this.fetchAuthorizedDomains().then(\n      () => {\n        return request(`${root}/rest/info`, {\n          credentials: this.getDomainCredentials(url)\n        })\n          .then((response) => {\n            if (response.owningSystemUrl) {\n              /**\n               * if this server is not owned by this portal\n               * bail out with an error since we know we wont\n               * be able to generate a token\n               */\n              if (!isFederated(response.owningSystemUrl, this.portal)) {\n                throw new ArcGISAuthError(\n                  `${url} is not federated with ${this.portal}.`,\n                  \"NOT_FEDERATED\"\n                );\n              } else {\n                /**\n                 * if the server is federated, use the relevant token endpoint.\n                 */\n                return request(\n                  `${response.owningSystemUrl}/sharing/rest/info`,\n                  requestOptions\n                );\n              }\n            } else if (\n              response.authInfo &&\n              this.federatedServers[root] !== undefined\n            ) {\n              /**\n               * if its a stand-alone instance of ArcGIS Server that doesn't advertise\n               * federation, but the root server url is recognized, use its built in token endpoint.\n               */\n              return Promise.resolve({\n                authInfo: response.authInfo\n              });\n            } else {\n              throw new ArcGISAuthError(\n                `${url} is not federated with any portal and is not explicitly trusted.`,\n                \"NOT_FEDERATED\"\n              );\n            }\n          })\n          .then((response: any) => {\n            return response.authInfo.tokenServicesUrl;\n          })\n          .then((tokenServicesUrl: string) => {\n            // an expired token cant be used to generate a new token\n            if (this.token && this.tokenExpires.getTime() > Date.now()) {\n              return generateToken(tokenServicesUrl, {\n                params: {\n                  token: this.token,\n                  serverUrl: url,\n                  expiration: this.tokenDuration,\n                  client: \"referer\"\n                }\n              });\n              // generate an entirely fresh token if necessary\n            } else {\n              return generateToken(tokenServicesUrl, {\n                params: {\n                  username: this.username,\n                  password: this.password,\n                  expiration: this.tokenDuration,\n                  client: \"referer\"\n                }\n              }).then((response: any) => {\n                this._token = response.token;\n                this._tokenExpires = new Date(response.expires);\n                return response;\n              });\n            }\n          })\n          .then((response) => {\n            this.federatedServers[root] = {\n              expires: new Date(response.expires),\n              token: response.token\n            };\n            delete this._pendingTokenRequests[root];\n            return response.token;\n          });\n      }\n    );\n\n    return this._pendingTokenRequests[root];\n  }\n\n  /**\n   * Returns an unexpired token for the current `portal`.\n   */\n  private getFreshToken(requestOptions?: ITokenRequestOptions) {\n    if (this.token && !this.tokenExpires) {\n      return Promise.resolve(this.token);\n    }\n\n    if (\n      this.token &&\n      this.tokenExpires &&\n      this.tokenExpires.getTime() > Date.now()\n    ) {\n      return Promise.resolve(this.token);\n    }\n\n    if (!this._pendingTokenRequests[this.portal]) {\n      this._pendingTokenRequests[this.portal] = this.refreshCredentials(\n        requestOptions\n      ).then((manager) => {\n        this._pendingTokenRequests[this.portal] = null;\n        return manager.token;\n      });\n    }\n\n    return this._pendingTokenRequests[this.portal];\n  }\n\n  /**\n   * Refreshes the current `token` and `tokenExpires` with `username` and\n   * `password`.\n   */\n  private refreshWithUsernameAndPassword(\n    requestOptions?: ITokenRequestOptions\n  ) {\n    const options = {\n      params: {\n        username: this.username,\n        password: this.password,\n        expiration: this.tokenDuration\n      },\n      ...requestOptions\n    };\n    return generateToken(`${this.portal}/generateToken`, options).then(\n      (response: any) => {\n        this._token = response.token;\n        this._tokenExpires = new Date(response.expires);\n        return this;\n      }\n    );\n  }\n\n  /**\n   * Refreshes the current `token` and `tokenExpires` with `refreshToken`.\n   */\n  private refreshWithRefreshToken(requestOptions?: ITokenRequestOptions) {\n    if (\n      this.refreshToken &&\n      this.refreshTokenExpires &&\n      this.refreshTokenExpires.getTime() < Date.now()\n    ) {\n      return this.refreshRefreshToken(requestOptions);\n    }\n\n    const options: ITokenRequestOptions = {\n      params: {\n        client_id: this.clientId,\n        refresh_token: this.refreshToken,\n        grant_type: \"refresh_token\"\n      },\n      ...requestOptions\n    };\n\n    return fetchToken(`${this.portal}/oauth2/token`, options).then(\n      (response) => {\n        this._token = response.token;\n        this._tokenExpires = response.expires;\n        return this;\n      }\n    );\n  }\n\n  /**\n   * Exchanges an unexpired `refreshToken` for a new one, also updates `token` and\n   * `tokenExpires`.\n   */\n  private refreshRefreshToken(requestOptions?: ITokenRequestOptions) {\n    const options: ITokenRequestOptions = {\n      params: {\n        client_id: this.clientId,\n        refresh_token: this.refreshToken,\n        redirect_uri: this.redirectUri,\n        grant_type: \"exchange_refresh_token\"\n      },\n      ...requestOptions\n    };\n\n    return fetchToken(`${this.portal}/oauth2/token`, options).then(\n      (response) => {\n        this._token = response.token;\n        this._tokenExpires = response.expires;\n        this._refreshToken = response.refreshToken;\n        this._refreshTokenExpires = new Date(\n          Date.now() + (this.refreshTokenTTL - 1) * 60 * 1000\n        );\n        return this;\n      }\n    );\n  }\n\n  /**\n   * ensures that the authorizedCrossOriginDomains are obtained from the portal and cached\n   * so we can check them later.\n   *\n   * @returns this\n   */\n  private fetchAuthorizedDomains() {\n    // if this token is for a specific server or we don't have a portal\n    // don't get the portal info because we cant get the authorizedCrossOriginDomains\n    if (this.server || !this.portal) {\n      return Promise.resolve(this);\n    }\n\n    return this.getPortal().then((portalInfo) => {\n      /**\n       * Specific domains can be configured as secure.esri.com or https://secure.esri.com this\n       * normalizes to https://secure.esri.com so we can use startsWith later.\n       */\n      if (\n        portalInfo.authorizedCrossOriginDomains &&\n        portalInfo.authorizedCrossOriginDomains.length\n      ) {\n        this.trustedDomains = portalInfo.authorizedCrossOriginDomains\n          .filter((d: string) => !d.startsWith(\"http://\"))\n          .map((d: string) => {\n            if (d.startsWith(\"https://\")) {\n              return d;\n            } else {\n              return `https://${d}`;\n            }\n          });\n      }\n      return this;\n    });\n  }\n}\n\n/**\n * @deprecated - Use {@linkcode ArcGISIdentityManager}.\n */ /* istanbul ignore next */\nexport function UserSession(options: IArcGISIdentityManagerOptions) {\n  console.log(\n    \"DEPRECATED:, 'UserSession' is deprecated. Use 'ArcGISIdentityManagerOptions' instead.\"\n  );\n\n  return new ArcGISIdentityManager(options);\n}\n","/* Copyright (c) 2018-2020 Environmental Systems Research Institute, Inc.\n * Apache-2.0 */\n\nimport { request } from \"./request.js\";\nimport { IRequestOptions } from \"./utils/IRequestOptions.js\";\n\n/**\n * Request app-specific token, passing in the token for the current app.\n *\n * This call returns a token after performing the same checks made by validateAppAccess.\n * It returns an app-specific token of the signed-in user only if the user has access\n * to the app and the encrypted platform cookie is valid.\n *\n * A scenario where an app would use this is if it is iframed into another platform app\n * and receives credentials via postMessage. Those credentials contain a token that is\n * specific to the host app, so the embedded app would use `exchangeToken` to get one\n * that is specific to itself.\n *\n * Note: This is only usable by Esri applications hosted on *arcgis.com, *esri.com or within\n * an ArcGIS Enterprise installation. Custom applications can not use this.\n *\n * @param token\n * @param clientId application\n * @param portal\n */\nexport function exchangeToken(\n  token: string,\n  clientId: string,\n  portal = \"https://www.arcgis.com/sharing/rest\"\n): Promise<string> {\n  const url = `${portal}/oauth2/exchangeToken`;\n  const ro = {\n    method: \"POST\",\n    params: {\n      f: \"json\",\n      client_id: clientId,\n      token\n    }\n  } as IRequestOptions;\n  // make the request and return the token\n  return request(url, ro).then((response) => response.token);\n}\n\n/**\n * Response from the `platformSelf(...)` function.\n */\nexport interface IPlatformSelfResponse {\n  /**\n   * Username of the user the encrypted cookie was issued for\n   */\n  username: string;\n  /**\n   * Token the consuming application can use, It is tied to the\n   * clientId used in the `platformSelf` call\n   */\n  token: string;\n  /**\n   * Token expiration, in seconds-from-now\n   */\n  expires_in: number;\n}\n\n/**\n * Request a token for a specific application using the esri_aopc encrypted cookie\n *\n * When a client app boots up, it will know its clientId and the redirectUri for use\n * in the normal /oauth/authorize pop-out oAuth flow.\n *\n * If the app sees an `esri_aopc` cookie (only set if the app is hosted on *.arcgis.com),\n * it can call the /oauth2/platformSelf end-point passing in the clientId and redirectUri\n * in headers, and it will receive back an app-specific token, assuming the user has\n * access to the app.\n *\n * Since there are scenarios where an app can boot using credentials/token from localstorage\n * but those credentials are not for the same user as the esri_aopc cookie, it is recommended that\n * an app check the returned username against any existing identity they may have loaded.\n *\n * Note: This is only usable by Esri applications hosted on *arcgis.com, *esri.com or within\n * an ArcGIS Enterprise installation. Custom applications can not use this.\n *\n * ```js\n * // convert the encrypted platform cookie into a ArcGISIdentityManager\n * import { platformSelf, ArcGISIdentityManager } from '@esri/arcgis-rest-auth';\n *\n * const portal = 'https://www.arcgis.com/sharing/rest';\n * const clientId = 'YOURAPPCLIENTID';\n *\n * // exchange esri_aopc cookie\n * return platformSelf(clientId, 'https://your-app-redirect-uri', portal)\n * .then((response) => {\n *  const currentTimestamp = new Date().getTime();\n *  const tokenExpiresTimestamp = currentTimestamp + (response.expires_in * 1000);\n *  // Construct the session and return it\n *  return new ArcGISIdentityManager({\n *    portal,\n *    clientId,\n *    username: response.username,\n *    token: response.token,\n *    tokenExpires: new Date(tokenExpiresTimestamp),\n *    ssl: true\n *  });\n * })\n *\n * ```\n *\n *\n * @param clientId\n * @param redirectUri\n * @param portal\n */\nexport function platformSelf(\n  clientId: string,\n  redirectUri: string,\n  portal = \"https://www.arcgis.com/sharing/rest\"\n): Promise<IPlatformSelfResponse> {\n  // TEMPORARY: the f=json should not be needed, but currently is\n  const url = `${portal}/oauth2/platformSelf?f=json`;\n  const ro = {\n    method: \"POST\",\n    headers: {\n      \"X-Esri-Auth-Client-Id\": clientId,\n      \"X-Esri-Auth-Redirect-Uri\": redirectUri\n    },\n    // Note: request has logic to include the cookie\n    // for platformSelf calls w/ the X-Esri-Auth-Client-Id header\n    params: {\n      f: \"json\"\n    }\n  } as IRequestOptions;\n  // make the request and return the token\n  return request(url, ro);\n}\n"],"names":["Blob","ErrorTypes"],"mappings":"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"}